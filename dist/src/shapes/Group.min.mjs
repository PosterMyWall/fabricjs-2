import{defineProperty as t,objectSpread2 as e,objectWithoutProperties as s}from"../../_virtual/_rollupPluginBabelHelpers.min.mjs";import{createCollectionMixin as r}from"../Collection.min.mjs";import{multiplyTransformMatrices as o,invertTransform as i}from"../util/misc/matrix.min.mjs";import{enlivenObjects as n,enlivenObjectEnlivables as a}from"../util/misc/objectEnlive.min.mjs";import{applyTransformToObject as c}from"../util/misc/objectTransforms.min.mjs";import{FabricObject as h}from"./Object/FabricObject.min.mjs";import{Rect as l}from"./Rect.min.mjs";import{classRegistry as u}from"../ClassRegistry.min.mjs";import{log as g}from"../util/internals/console.min.mjs";import{LayoutManager as p}from"../LayoutManager/LayoutManager.min.mjs";import{LAYOUT_TYPE_INITIALIZATION as d,LAYOUT_TYPE_ADDED as f,LAYOUT_TYPE_REMOVED as b,LAYOUT_TYPE_IMPERATIVE as _}from"../LayoutManager/constants.min.mjs";const j=["type","objects","layoutManager"];class m extends p{performLayout(){}}const v={strokeWidth:0,subTargetCheck:!1,caterCacheForTextChildren:!1,selected:!1,useSelectedFlag:!1,interactive:!1};class y extends(r(h)){static getDefaults(){return e(e({},super.getDefaults()),y.ownDefaults)}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),t(this,"_activeObjects",[]),t(this,"__objectSelectionTracker",void 0),t(this,"__objectSelectionDisposer",void 0),Object.assign(this,y.ownDefaults),this.setOptions(s),this.groupInit(e,s)}onDeselect(t){return this.useSelectedFlag&&(this.selected=!1),super.onDeselect(t)}_getCacheCanvasDimensions(){if(this.caterCacheForTextChildren){const t=super._getCacheCanvasDimensions();let e=0,s=0;const r=this._getMaxExpandedFontSizeFromTextChildren();return r>0&&(e=r*t.zoomX,s=r*t.zoomY),t.width+=e,t.height+=s,t}return super._getCacheCanvasDimensions()}_getMaxExpandedFontSizeFromTextChildren(){const t=this.getObjects();let e=0;for(const s of t)if("fontSize"in s){const t=s.fontSize;t>e&&(e=t*s.cacheExpansionFactor)}else if(s instanceof y){const t=s._getMaxExpandedFontSizeFromTextChildren();t>e&&(e=t)}return e}groupInit(t,e){var s;this._objects=[...t],this.__objectSelectionTracker=this.__objectSelectionMonitor.bind(this,!0),this.__objectSelectionDisposer=this.__objectSelectionMonitor.bind(this,!1),this.forEachObject((t=>{this.enterGroup(t,!1)})),this.layoutManager=null!==(s=e.layoutManager)&&void 0!==s?s:new p,this.layoutManager.performLayout({type:d,target:this,targets:[...t],x:e.left,y:e.top})}canEnterGroup(t){return t===this||this.isDescendantOf(t)?(g("error","Group: circular object trees are not supported, this call has no effect"),!1):-1===this._objects.indexOf(t)||(g("error","Group: duplicate objects are not supported inside group, this call has no effect"),!1)}_filterObjectsBeforeEnteringGroup(t){return t.filter(((t,e,s)=>this.canEnterGroup(t)&&s.indexOf(t)===e))}add(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const r=this._filterObjectsBeforeEnteringGroup(e),o=super.add(...r);return this._onAfterObjectsChange(f,r),o}insertAt(t){for(var e=arguments.length,s=new Array(e>1?e-1:0),r=1;r<e;r++)s[r-1]=arguments[r];const o=this._filterObjectsBeforeEnteringGroup(s),i=super.insertAt(t,...o);return this._onAfterObjectsChange(f,o),i}remove(){const t=super.remove(...arguments);return this._onAfterObjectsChange(b,t),t}_onObjectAdded(t){this.enterGroup(t,!0),this.fire("object:added",{target:t}),t.fire("added",{target:this})}_onObjectRemoved(t,e){this.exitGroup(t,e),this.fire("object:removed",{target:t}),t.fire("removed",{target:this})}_onAfterObjectsChange(t,e){this.layoutManager.performLayout({type:t,targets:e,target:this})}_onStackOrderChanged(){this._set("dirty",!0)}_set(t,e){const s=this[t];return super._set(t,e),"canvas"===t&&s!==e&&(this._objects||[]).forEach((s=>{s._set(t,e)})),this}_shouldSetNestedCoords(){return this.subTargetCheck}removeAll(){return this._activeObjects=[],this.remove(...this._objects)}__objectSelectionMonitor(t,e){let{target:s}=e;const r=this._activeObjects;if(t)r.push(s),this._set("dirty",!0);else if(r.length>0){const t=r.indexOf(s);t>-1&&(r.splice(t,1),this._set("dirty",!0))}}_watchObject(t,e){t&&this._watchObject(!1,e),t?(e.on("selected",this.__objectSelectionTracker),e.on("deselected",this.__objectSelectionDisposer)):(e.off("selected",this.__objectSelectionTracker),e.off("deselected",this.__objectSelectionDisposer))}enterGroup(t,e){t.group&&t.group.remove(t),t._set("parent",this),this._enterGroup(t,e)}_enterGroup(t,e){e&&c(t,o(i(this.calcTransformMatrix()),t.calcTransformMatrix())),this._shouldSetNestedCoords()&&t.setCoords(),t._set("group",this),t._set("canvas",this.canvas),this._watchObject(!0,t);const s=this.canvas&&this.canvas.getActiveObject&&this.canvas.getActiveObject();s&&(s===t||t.isDescendantOf(s))&&this._activeObjects.push(t)}exitGroup(t,e){this._exitGroup(t,e),t._set("parent",void 0),t._set("canvas",void 0)}_exitGroup(t,e){t._set("group",void 0),e||(c(t,o(this.calcTransformMatrix(),t.calcTransformMatrix())),t.setCoords()),this._watchObject(!1,t);const s=this._activeObjects.length>0?this._activeObjects.indexOf(t):-1;s>-1&&this._activeObjects.splice(s,1)}shouldCache(){const t=h.prototype.shouldCache.call(this);if(t)for(let t=0;t<this._objects.length;t++)if(this._objects[t].willDrawShadow())return this.ownCaching=!1,!1;return t}willDrawShadow(){if(super.willDrawShadow())return!0;for(let t=0;t<this._objects.length;t++)if(this._objects[t].willDrawShadow())return!0;return!1}isGroup(){return!0}isOnACache(){return this.ownCaching||!!this.parent&&this.parent.isOnACache()}drawObject(t,e,s){this._renderBackground(t);for(let e=0;e<this._objects.length;e++){var r;const s=this._objects[e];null!==(r=this.canvas)&&void 0!==r&&r.preserveObjectStacking&&s.group!==this?(t.save(),t.transform(...i(this.calcTransformMatrix())),s.render(t),t.restore()):s.group===this&&s.render(t)}this._drawClipPath(t,this.clipPath,s)}setCoords(){super.setCoords(),this._shouldSetNestedCoords()&&this.forEachObject((t=>t.setCoords()))}triggerLayout(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.layoutManager.performLayout(e({target:this,type:_},t))}render(t){this._transformDone=!0,super.render(t),this._transformDone=!1}isTable(){return!1}__serializeObjects(t,e){const s=this.includeDefaultValues;return this._objects.filter((function(t){return!t.excludeFromExport})).map((function(r){const o=r.includeDefaultValues;r.includeDefaultValues=s;const i=r[t||"toObject"](e);return r.includeDefaultValues=o,i}))}toObject(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const s=this.layoutManager.toObject();return e(e(e({},super.toObject(["subTargetCheck","interactive",...t])),"fit-content"!==s.strategy||this.includeDefaultValues?{layoutManager:s}:{}),{},{objects:this.__serializeObjects("toObject",t)})}toString(){return"#<Group: (".concat(this.complexity(),")>")}dispose(){this.layoutManager.unsubscribeTargets({targets:this.getObjects(),target:this}),this._activeObjects=[],this.forEachObject((t=>{this._watchObject(!1,t),t.dispose()})),super.dispose()}_createSVGBgRect(t){if(!this.backgroundColor)return"";const e=l.prototype._toSVG.call(this),s=e.indexOf("COMMON_PARTS");e[s]='for="group" ';const r=e.join("");return t?t(r):r}_toSVG(t){const e=["<g ","COMMON_PARTS"," >\n"],s=this._createSVGBgRect(t);s&&e.push("\t\t",s);for(let s=0;s<this._objects.length;s++)e.push("\t\t",this._objects[s].toSVG(t));return e.push("</g>\n"),e}getSvgStyles(){const t=void 0!==this.opacity&&1!==this.opacity?"opacity: ".concat(this.opacity,";"):"",e=this.visible?"":" visibility: hidden;";return[t,this.getSvgFilter(),e].join("")}toClipPathSVG(t){const e=[],s=this._createSVGBgRect(t);s&&e.push("\t",s);for(let s=0;s<this._objects.length;s++)e.push("\t",this._objects[s].toClipPathSVG(t));return this._createBaseClipPathSVGMarkup(e,{reviver:t})}horizontalAlignment(t){var e;const s=this.width,r=this._objects,o=this.padding;let i,n,a,c=0;switch(t){case"left":for(c=0;c<r.length;c++){i=r[c].getCornerPoints(r[c].getCenterPoint()),n=i.tl.x;const t=Math.min(n,i.tr.x,i.bl.x,i.br.x);a=t<n?n-t:0,r[c].set("left",-s/2+o+a)}break;case"right":for(c=0;c<r.length;c++){i=r[c].getCornerPoints(r[c].getCenterPoint()),n=i.tl.x;const t=Math.max(n,i.tr.x,i.bl.x,i.br.x);a=t>n?t-n:0,r[c].set("left",s/2-a-o)}break;case"center":for(c=0;c<r.length;c++)i=r[c].getCornerPoints({x:0,y:r[c].top}),r[c].set("left",i.tl.x);break;default:return}null===(e=this.canvas)||void 0===e||e.fire("object:modified",{target:this})}verticalAlignment(t){var e;const s=this.height,r=this._objects,o=this.padding;let i,n,a,c=0;switch(t){case"top":for(c=0;c<r.length;c++){i=r[c].getCornerPoints(r[c].getCenterPoint()),n=i.tl.y;const t=Math.min(n,i.tr.y,i.bl.y,i.br.y);a=t<n?n-t:0,r[c].set("top",-s/2+o+a)}break;case"bottom":for(c=0;c<r.length;c++){i=r[c].getCornerPoints(r[c].getCenterPoint()),n=i.tl.y;const t=Math.max(n,i.tr.y,i.bl.y,i.br.y);a=t>n?t-n:0,r[c].set("top",s/2-o-a)}break;case"center":for(c=0;c<r.length;c++)i=r[c].getCornerPoints({x:r[c].left,y:0}),r[c].set("top",i.tl.y);break;default:return}null===(e=this.canvas)||void 0===e||e.fire("object:modified",{target:this})}static fromObject(t,r){let{type:o,objects:i=[],layoutManager:c}=t,h=s(t,j);return Promise.all([n(i,r),a(h,r)]).then((t=>{let[s,r]=t;const o=new this(s,e(e(e({},h),r),{},{layoutManager:new m}));if(c){const t=u.getClass(c.type),e=u.getClass(c.strategy);o.layoutManager=new t(new e)}else o.layoutManager=new p;return o.layoutManager.subscribeTargets({type:d,target:o,targets:o.getObjects()}),o.setCoords(),o}))}}t(y,"type","Group"),t(y,"ownDefaults",v),u.setClass(y);export{y as Group,v as groupDefaultValues};
//# sourceMappingURL=Group.min.mjs.map
