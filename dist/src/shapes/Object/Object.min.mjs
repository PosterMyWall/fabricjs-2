import{defineProperty as t,objectSpread2 as e,objectWithoutProperties as i}from"../../../_virtual/_rollupPluginBabelHelpers.min.mjs";import{cache as s}from"../../cache.min.mjs";import{config as o}from"../../config.min.mjs";import{ALIASING_LIMIT as r,SCALE_X as n,SCALE_Y as a,STROKE as h,iMatrix as c,CENTER as l,VERSION as m,FILL as d,LEFT as f,TOP as p}from"../../constants.min.mjs";import{Point as g}from"../../Point.min.mjs";import{Shadow as u}from"../../Shadow.min.mjs";import{classRegistry as C}from"../../ClassRegistry.min.mjs";import{runningAnimations as w}from"../../util/animation/AnimationRegistry.min.mjs";import{capValue as v}from"../../util/misc/capValue.min.mjs";import{createCanvasElement as _,createCanvasElementFor as b,toDataURL as y,toBlob as k}from"../../util/misc/dom.min.mjs";import{qrDecompose as O,invertTransform as j}from"../../util/misc/matrix.min.mjs";import{enlivenObjectEnlivables as S}from"../../util/misc/objectEnlive.min.mjs";import{saveObjectTransform as P,resetObjectTransform as T}from"../../util/misc/objectTransforms.min.mjs";import{sendObjectToPlane as x}from"../../util/misc/planeChange.min.mjs";import{pick as Y,pickBy as X}from"../../util/misc/pick.min.mjs";import{toFixed as D}from"../../util/misc/toFixed.min.mjs";import{StaticCanvas as M}from"../../canvas/StaticCanvas.min.mjs";import{isFiller as F,isSerializableFiller as z}from"../../util/typeAssertions.min.mjs";import{stateProperties as A,cacheProperties as L,fabricObjectDefaultValues as B}from"./defaultValues.min.mjs";import{getDevicePixelRatio as R,getEnv as V}from"../../env/index.min.mjs";import{log as G}from"../../util/internals/console.min.mjs";import{animateColor as W,animate as E}from"../../util/animation/animate.min.mjs";import{ObjectGeometry as I}from"./ObjectGeometry.min.mjs";import{degreesToRadians as N}from"../../util/misc/radiansDegreesConversion.min.mjs";const U=["type"],J=["extraParam"];class q extends I{static getDefaults(){return q.ownDefaults}get type(){const t=this.constructor.type;return"FabricObject"===t?"object":t.toLowerCase()}set type(t){G("warn","Setting type has no effect",t)}constructor(e){super(),t(this,"_cacheContext",null),Object.assign(this,q.ownDefaults),this.setOptions(e)}_createCacheCanvas(){this._cacheCanvas=_(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0}_limitCacheSize(t){const e=t.width,i=t.height,r=o.maxCacheSideLimit,n=o.minCacheSideLimit;if(e<=r&&i<=r&&e*i<=o.perfLimitSizeTotal)return e<n&&(t.width=n),i<n&&(t.height=n),t;const a=e/i,[h,c]=s.limitDimsByArea(a),l=v(n,h,r),m=v(n,c,r);return e>l&&(t.zoomX/=e/l,t.width=l,t.capped=!0),i>m&&(t.zoomY/=i/m,t.height=m,t.capped=!0),t}_getCacheCanvasDimensions(){const t=this.getTotalObjectScaling(),e=this._getTransformedDimensions({skewX:0,skewY:0}),i=e.x*t.x/this.scaleX,s=e.y*t.y/this.scaleY;return{width:Math.ceil(i+r),height:Math.ceil(s+r),zoomX:t.x,zoomY:t.y,x:i,y:s}}_updateCacheCanvas(){const t=this._cacheCanvas,e=this._cacheContext,{width:i,height:s,zoomX:o,zoomY:r,x:n,y:a}=this._limitCacheSize(this._getCacheCanvasDimensions()),h=i!==t.width||s!==t.height,c=this.zoomX!==o||this.zoomY!==r;if(!t||!e)return!1;if(h||c){i!==t.width||s!==t.height?(t.width=i,t.height=s):(e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,t.width,t.height));const h=n/2,c=a/2;return this.cacheTranslationX=Math.round(t.width/2-h)+h,this.cacheTranslationY=Math.round(t.height/2-c)+c,e.translate(this.cacheTranslationX,this.cacheTranslationY),e.scale(o,r),this.zoomX=o,this.zoomY=r,!0}return!1}setOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._setOptions(t)}transform(t){const e=this.group&&!this.group._transformDone||this.group&&this.canvas&&t===this.canvas.contextTop,i=this.calcTransformMatrix(!e);t.transform(i[0],i[1],i[2],i[3],i[4],i[5])}getObjectScaling(){if(!this.group)return new g(Math.abs(this.scaleX),Math.abs(this.scaleY));const t=O(this.calcTransformMatrix());return new g(Math.abs(t.scaleX),Math.abs(t.scaleY))}getTotalObjectScaling(){const t=this.getObjectScaling();if(this.canvas){const e=this.canvas.getZoom(),i=this.getCanvasRetinaScaling();return t.scalarMultiply(e*i)}return t}getObjectOpacity(){let t=this.opacity;return this.group&&(t*=this.group.getObjectOpacity()),t}_constrainScale(t){return Math.abs(t)<this.minScaleLimit?t<0?-this.minScaleLimit:this.minScaleLimit:0===t?1e-4:t}_set(t,e){t!==n&&t!==a||(e=this._constrainScale(e)),t===n&&e<0?(this.flipX=!this.flipX,e*=-1):"scaleY"===t&&e<0?(this.flipY=!this.flipY,e*=-1):"shadow"!==t||!e||e instanceof u||(e=new u(e));const i=this[t]!==e;return this[t]=e,i&&this.constructor.cacheProperties.includes(t)&&(this.dirty=!0),this.parent&&(this.dirty||i&&this.constructor.stateProperties.includes(t))&&this.parent._set("dirty",!0),this}isNotVisible(){return 0===this.opacity||!this.width&&!this.height&&0===this.strokeWidth||!this.visible}render(t){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(t.save(),this._setupCompositeOperation(t),this.drawSelectionBackground(t),this.transform(t),this._setOpacity(t),this._setShadow(t),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(t)):(this._removeCacheCanvas(),this.drawObject(t,!1,{}),this.dirty=!1),t.restore())}drawSelectionBackground(t){}renderCache(t){if(t=t||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&this._cacheContext){const{zoomX:e,zoomY:i,cacheTranslationX:s,cacheTranslationY:o}=this,{width:r,height:n}=this._cacheCanvas;this.drawObject(this._cacheContext,t.forClipping,{zoomX:e,zoomY:i,cacheTranslationX:s,cacheTranslationY:o,width:r,height:n,parentClipPaths:[]}),this.dirty=!1}}_removeCacheCanvas(){this._cacheCanvas=void 0,this._cacheContext=null}hasStroke(){return this.stroke&&"transparent"!==this.stroke&&0!==this.strokeWidth}hasFill(){return this.fill&&"transparent"!==this.fill}needsItsOwnCache(){return!!(this.paintFirst===h&&this.hasFill()&&this.hasStroke()&&this.shadow)||!!this.clipPath}shouldCache(){return this.ownCaching=this.objectCaching&&(!this.parent||!this.parent.isOnACache())||this.needsItsOwnCache(),this.ownCaching}willDrawShadow(){return!!this.shadow&&(0!==this.shadow.offsetX||0!==this.shadow.offsetY)}drawClipPathOnCache(t,e,i){t.save(),e.inverted?t.globalCompositeOperation="destination-out":t.globalCompositeOperation="destination-in",t.setTransform(1,0,0,1,0,0),t.drawImage(i,0,0),t.restore()}drawObject(t,e,i){const s=this.fill,o=this.stroke;e?(this.fill="black",this.stroke="",this._setClippingProperties(t)):this._renderBackground(t),this._render(t),this._drawClipPath(t,this.clipPath,i),this.fill=s,this.stroke=o}createClipPathLayer(t,e){const i=b(e),s=i.getContext("2d");if(s.translate(e.cacheTranslationX,e.cacheTranslationY),s.scale(e.zoomX,e.zoomY),t._cacheCanvas=i,e.parentClipPaths.forEach((t=>{t.transform(s)})),e.parentClipPaths.push(t),t.absolutePositioned){const t=j(this.calcTransformMatrix());s.transform(t[0],t[1],t[2],t[3],t[4],t[5])}return t.transform(s),t.drawObject(s,!0,e),i}_drawClipPath(t,e,i){if(!e)return;e._transformDone=!0;const s=this.createClipPathLayer(e,i);this.drawClipPathOnCache(t,e,s)}drawCacheOnCanvas(t){t.scale(1/this.zoomX,1/this.zoomY),t.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)}isCacheDirty(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.isNotVisible())return!1;const e=this._cacheCanvas,i=this._cacheContext;return!(!e||!i||t||!this._updateCacheCanvas())||!!(this.dirty||this.clipPath&&this.clipPath.absolutePositioned)&&(e&&i&&!t&&(i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,e.width,e.height),i.restore()),!0)}_renderBackground(t){if(this.backgroundColor){if(this.leanBackground){t.save(),t.fillStyle=this.backgroundColor,t.beginPath();const e=this.leanBackgroundOffset/4,i=this.leanBackgroundOffset/2,s=this.leanBackgroundOffset/10;t.moveTo(-this.width/2+e,-this.height/2-s),t.lineTo(-this.width/2+this.width+e,-this.height/2-s),t.lineTo(-this.width/2+this.width-i+e,-this.height/2+this.height-s),t.lineTo(-this.width/2-i+e,-this.height/2+this.height-s),t.closePath(),t.fill(),t.restore()}else{const e=this._getNonTransformedDimensions();t.fillStyle=this.backgroundColor,t.fillRect(-e.x/2,-e.y/2,e.x,e.y)}this._removeShadow(t)}}_setOpacity(t){this.group&&!this.group._transformDone?t.globalAlpha=this.getObjectOpacity():t.globalAlpha*=this.opacity}_setStrokeStyles(t,e){const i=e.stroke;i&&(t.lineWidth=e.strokeWidth,t.lineCap=e.strokeLineCap,t.lineDashOffset=e.strokeDashOffset,t.lineJoin=e.strokeLineJoin,t.miterLimit=e.strokeMiterLimit,F(i)?"percentage"===i.gradientUnits||i.gradientTransform||i.patternTransform?this._applyPatternForTransformedGradient(t,i):(t.strokeStyle=i.toLive(t),this._applyPatternGradientTransform(t,i)):t.strokeStyle=e.stroke)}_setFillStyles(t,e){let{fill:i}=e;i&&(F(i)?(t.fillStyle=i.toLive(t),this._applyPatternGradientTransform(t,i)):t.fillStyle=i)}_setClippingProperties(t){t.globalAlpha=1,t.strokeStyle="transparent",t.fillStyle="#000000"}_setLineDash(t,e){e&&0!==e.length&&t.setLineDash(e)}_setShadow(t){if(!this.shadow)return;const e=this.shadow,i=this.canvas,s=this.getCanvasRetinaScaling(),[r,,,n]=(null==i?void 0:i.viewportTransform)||c,a=r*s,h=n*s,l=e.nonScaling?new g(1,1):this.getObjectScaling();t.shadowColor=e.color,t.shadowBlur=e.blur*o.browserShadowBlurConstant*(a+h)*(l.x+l.y)/4,t.shadowOffsetX=e.offsetX*a*l.x,t.shadowOffsetY=e.offsetY*h*l.y}_removeShadow(t){this.shadow&&(t.shadowColor="",t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0)}_applyPatternGradientTransform(t,e){if(!F(e))return{offsetX:0,offsetY:0};const i=e.gradientTransform||e.patternTransform,s=-this.width/2+e.offsetX||0,o=-this.height/2+e.offsetY||0;return"percentage"===e.gradientUnits?t.transform(this.width,0,0,this.height,s,o):t.transform(1,0,0,1,s,o),i&&t.transform(i[0],i[1],i[2],i[3],i[4],i[5]),{offsetX:s,offsetY:o}}_renderPaintInOrder(t){this.paintFirst===h?(this._renderStroke(t),this._renderFill(t)):(this._renderFill(t),this._renderStroke(t))}_render(t){}_renderFill(t){this.fill&&(t.save(),this._setFillStyles(t,this),"evenodd"===this.fillRule?t.fill("evenodd"):t.fill(),t.restore())}_renderStroke(t){if(this.stroke&&0!==this.strokeWidth){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this.strokeUniform){const e=this.getObjectScaling();t.scale(1/e.x,1/e.y)}this._setLineDash(t,this.strokeDashArray),this._setStrokeStyles(t,this),t.stroke(),t.restore()}}_applyPatternForTransformedGradient(t,e){var i;const s=this._limitCacheSize(this._getCacheCanvasDimensions()),o=this.getCanvasRetinaScaling(),r=s.x/this.scaleX/o,n=s.y/this.scaleY/o,a=b({width:Math.ceil(r),height:Math.ceil(n)}),h=a.getContext("2d");h&&(h.beginPath(),h.moveTo(0,0),h.lineTo(r,0),h.lineTo(r,n),h.lineTo(0,n),h.closePath(),h.translate(r/2,n/2),h.scale(s.zoomX/this.scaleX/o,s.zoomY/this.scaleY/o),this._applyPatternGradientTransform(h,e),h.fillStyle=e.toLive(t),h.fill(),t.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),t.scale(o*this.scaleX/s.zoomX,o*this.scaleY/s.zoomY),t.strokeStyle=null!==(i=h.createPattern(a,"no-repeat"))&&void 0!==i?i:"")}_findCenterFromElement(){return new g(this.left+this.width/2,this.top+this.height/2)}clone(t){const e=this.toObject(t);return this.constructor.fromObject(e)}cloneAsImage(t){const e=this.toCanvasElement(t);return new(C.getClass("image"))(e)}toCanvasElement(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=P(this),i=this.group,s=this.shadow,o=Math.abs,r=t.enableRetinaScaling?R():1,n=(t.multiplier||1)*r,a=t.canvasProvider||(t=>new M(t,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1}));delete this.group,t.withoutTransform&&T(this),t.withoutShadow&&(this.shadow=null),t.viewportTransform&&x(this,this.getViewportTransform()),this.setCoords();const h=_(),c=this.getBoundingRect(),m=this.shadow,d=new g;if(t.expandBoundingBoxByFont&&this.isGroup()){let t=0,e=0;this._getMaxExpandedFontSizeFromTextChildren()>0&&(t=.75*c.width,e=.75*c.height),c.width+=t,c.height+=e}if(m){const t=m.blur,e=m.nonScaling?new g(1,1):this.getObjectScaling();d.x=2*Math.round(o(m.offsetX)+t)*o(e.x),d.y=2*Math.round(o(m.offsetY)+t)*o(e.y)}const f=c.width+d.x,p=c.height+d.y;h.width=Math.ceil(f),h.height=Math.ceil(p);const u=a(h);"jpeg"===t.format&&(u.backgroundColor="#fff"),this.setPositionByOrigin(new g(u.width/2,u.height/2),l,l);const C=this.canvas;u._objects=[this],this.set("canvas",u),this.setCoords();const w=u.toCanvasElement(n||1,t);return this.set("canvas",C),this.shadow=s,i&&(this.group=i),this.set(e),this.setCoords(),u._objects=[],u.destroy(),w}isGroup(){return!1}getCornerPoints(t){const e=this.angle;let i=this.getScaledWidth();const s=this.getScaledHeight(),o=t.x,r=t.y,n=N(e);i<0&&(i=Math.abs(i));const a=Math.sin(n),h=Math.cos(n),c=i>0?Math.atan(s/i):0,l=i/Math.cos(c)/2,m=Math.cos(c+n)*l,d=Math.sin(c+n)*l;return{tl:new g(o-m,r-d),tr:new g(o-m+i*h,r-d+i*a),bl:new g(o-m-s*a,r-d+s*h),br:new g(o+m,r+d)}}toDataURL(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return y(this.toCanvasElement(t),t.format||"png",t.quality||1)}toBlob(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return k(this.toCanvasElement(t),t.format||"png",t.quality||1)}isType(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return e.includes(this.constructor.type)||e.includes(this.type)}complexity(){return 1}toJSON(){return this.toObject()}rotate(t){const{centeredRotation:e,originX:i,originY:s}=this;if(e){const{x:t,y:e}=this.getRelativeCenterPoint();this.originX=l,this.originY=l,this.left=t,this.top=e}if(this.set("angle",t),e){const{x:t,y:e}=this.translateToOriginPoint(this.getRelativeCenterPoint(),i,s);this.left=t,this.top=e,this.originX=i,this.originY=s}}setOnGroup(){}_setupCompositeOperation(t){this.globalCompositeOperation&&(t.globalCompositeOperation=this.globalCompositeOperation)}dispose(){w.cancelByTarget(this),this.off(),this._set("canvas",void 0),this._cacheCanvas&&V().dispose(this._cacheCanvas),this._cacheCanvas=void 0,this._cacheContext=null}animate(t,e){return Object.entries(t).reduce(((t,i)=>{let[s,o]=i;return t[s]=this._animate(s,o,e),t}),{})}_animate(t,i){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o=t.split("."),r=this.constructor.colorProperties.includes(o[o.length-1]),{abort:n,startValue:a,onChange:h,onComplete:c}=s,l=e(e({},s),{},{target:this,startValue:null!=a?a:o.reduce(((t,e)=>t[e]),this),endValue:i,abort:null==n?void 0:n.bind(this),onChange:(t,e,i)=>{o.reduce(((e,i,s)=>(s===o.length-1&&(e[i]=t),e[i])),this),h&&h(t,e,i)},onComplete:(t,e,i)=>{this.setCoords(),c&&c(t,e,i)}});return r?W(l):E(l)}isDescendantOf(t){const{parent:e,group:i}=this;return e===t||i===t||!!e&&e.isDescendantOf(t)||!!i&&i!==e&&i.isDescendantOf(t)}getAncestors(){const t=[];let e=this;do{e=e.parent,e&&t.push(e)}while(e);return t}findCommonAncestors(t){if(this===t)return{fork:[],otherFork:[],common:[this,...this.getAncestors()]};const e=this.getAncestors(),i=t.getAncestors();if(0===e.length&&i.length>0&&this===i[i.length-1])return{fork:[],otherFork:[t,...i.slice(0,i.length-1)],common:[this]};for(let s,o=0;o<e.length;o++){if(s=e[o],s===t)return{fork:[this,...e.slice(0,o)],otherFork:[],common:e.slice(o)};for(let r=0;r<i.length;r++){if(this===i[r])return{fork:[],otherFork:[t,...i.slice(0,r)],common:[this,...e]};if(s===i[r])return{fork:[this,...e.slice(0,o)],otherFork:[t,...i.slice(0,r)],common:e.slice(o)}}}return{fork:[this,...e],otherFork:[t,...i],common:[]}}hasCommonAncestors(t){const e=this.findCommonAncestors(t);return e&&!!e.common.length}isInFrontOf(t){if(this===t)return;const e=this.findCommonAncestors(t);if(e.fork.includes(t))return!0;if(e.otherFork.includes(this))return!1;const i=e.common[0]||this.canvas;if(!i)return;const s=e.fork.pop(),o=e.otherFork.pop(),r=i._objects.indexOf(s),n=i._objects.indexOf(o);return r>-1&&r>n}toObject(){const t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).concat(q.customProperties,this.constructor.customProperties||[]);let i;const s=o.NUM_FRACTION_DIGITS,{clipPath:r,fill:n,stroke:a,shadow:h,strokeDashArray:c,left:l,top:d,originX:f,originY:p,width:g,height:u,strokeWidth:C,strokeLineCap:w,strokeDashOffset:v,strokeLineJoin:_,strokeUniform:b,strokeMiterLimit:y,scaleX:k,scaleY:O,angle:j,flipX:S,flipY:P,opacity:T,visible:x,backgroundColor:X,fillRule:M,paintFirst:F,globalCompositeOperation:A,skewX:L,skewY:B}=this;r&&!r.excludeFromExport&&(i=r.toObject(t.concat("inverted","absolutePositioned")));const R=t=>D(t,s),V=e(e({},Y(this,t)),{},{type:this.constructor.type,version:m,originX:f,originY:p,left:R(l),top:R(d),width:R(g),height:R(u),fill:z(n)?n.toObject():n,stroke:z(a)?a.toObject():a,strokeWidth:R(C),strokeDashArray:c?c.concat():c,strokeLineCap:w,strokeDashOffset:v,strokeLineJoin:_,strokeUniform:b,strokeMiterLimit:R(y),scaleX:R(k),scaleY:R(O),angle:R(j),flipX:S,flipY:P,opacity:R(T),shadow:h?h.toObject():h,visible:x,backgroundColor:X,fillRule:M,paintFirst:F,globalCompositeOperation:A,skewX:R(L),skewY:R(B)},i?{clipPath:i}:null);return this.includeDefaultValues?V:this._removeDefaultValues(V)}toDatalessObject(t){return this.toObject(t)}_removeDefaultValues(t){const e=this.constructor.getDefaults(),i=Object.keys(e).length>0?e:Object.getPrototypeOf(this);return X(t,((t,e)=>{if(e===f||e===p||"type"===e)return!0;const s=i[e];return t!==s&&!(Array.isArray(t)&&Array.isArray(s)&&0===t.length&&0===s.length)}))}toString(){return"#<".concat(this.constructor.type,">")}static _fromObject(t){let e=i(t,U),s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{extraParam:o}=s,r=i(s,J);return S(e,r).then((t=>o?(delete t[o],new this(e[o],t)):new this(t)))}static fromObject(t,e){return this._fromObject(t,e)}}t(q,"stateProperties",A),t(q,"cacheProperties",L),t(q,"ownDefaults",B),t(q,"type","FabricObject"),t(q,"colorProperties",[d,h,"backgroundColor"]),t(q,"customProperties",[]),C.setClass(q),C.setClass(q,"object");export{q as FabricObject};
//# sourceMappingURL=Object.min.mjs.map
