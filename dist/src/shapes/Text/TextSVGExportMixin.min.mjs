import{config as t}from"../../config.min.mjs";import{escapeXml as e}from"../../util/lang_string.min.mjs";import{colorPropToSVG as i,createSVGRect as s}from"../../util/misc/svgParsing.min.mjs";import{hasStyleChanged as n}from"../../util/misc/textStyles.min.mjs";import{toFixed as o}from"../../util/misc/toFixed.min.mjs";import{FabricObjectSVGExportMixin as r}from"../Object/FabricObjectSVGExportMixin.min.mjs";import{JUSTIFY as h}from"./constants.min.mjs";import{STROKE as a,FILL as l}from"../../constants.min.mjs";import{createRotateMatrix as g}from"../../util/misc/matrix.min.mjs";import{radiansToDegrees as c}from"../../util/misc/radiansDegreesConversion.min.mjs";import{Point as m}from"../../Point.min.mjs";import{matrixToSVG as f}from"../../util/misc/svgExport.min.mjs";const d=/  +/g,p=/"/g;function S(t,e,i,n,o){return`\t\t${s(t,{left:e,top:i,width:n,height:o})}\n`}class x extends r{_toSVG(){const t=this._getSVGLeftTopOffsets(),e=this._getSVGTextAndBg(t.textTop,t.textLeft);return this._wrapSVGTextAndBg(e)}toSVG(t){const e=this._createBaseSVGMarkup(this._toSVG(),{reviver:t,noStyle:!0,withShadow:!0}),i=this.path;return i?e+i._createBaseSVGMarkup(i._toSVG(),{reviver:t,withShadow:!0,additionalTransform:f(this.calcOwnMatrix())}):e}_getSVGLeftTopOffsets(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}}_wrapSVGTextAndBg(t){let{textBgRects:e,textSpans:i}=t;const s=this.getSvgTextDecoration(this);return[e.join(""),'\t\t<text xml:space="preserve" ',this.fontFamily?`font-family="${this.fontFamily.replace(p,"'")}" `:"",this.fontSize?`font-size="${this.fontSize}" `:"",this.fontStyle?`font-style="${this.fontStyle}" `:"",this.fontWeight?`font-weight="${this.fontWeight}" `:"",s?`text-decoration="${s}" `:"","rtl"===this.direction?`direction="${this.direction}" `:"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",i.join(""),"</text>\n"]}_getSVGTextAndBg(t,e){const i=[],s=[];let n,o=t;this.backgroundColor&&s.push(...S(this.backgroundColor,-this.width/2,-this.height/2,this.width,this.height));for(let t=0,r=this._textLines.length;t<r;t++)n=this._getLineLeftOffset(t),"rtl"===this.direction&&(n+=this.width),(this.textBackgroundColor||this.styleHas("textBackgroundColor",t))&&this._setSVGTextLineBg(s,t,e+n,o),this._setSVGTextLineText(i,t,e+n,o),o+=this.getHeightOfLine(t);return{textSpans:i,textBgRects:s}}_createTextCharSpan(i,s,n,r,h){const a=t.NUM_FRACTION_DIGITS,l=this.getSvgSpanStyles(s,i!==i.trim()||!!i.match(d)),f=l?`style="${l}"`:"",p=s.deltaY,S=p?` dy="${o(p,a)}" `:"",{angle:x,renderLeft:u,renderTop:_,width:y}=h;let T="";if(void 0!==u){const t=y/2;x&&(T=` rotate="${o(c(x),a)}"`);const e=g({angle:c(x)});e[4]=u,e[5]=_;const i=new m(-t,0).transform(e);n=i.x,r=i.y}return`<tspan x="${o(n,a)}" y="${o(r,a)}" ${S}${T}${f}>${e(i)}</tspan>`}_setSVGTextLineText(t,e,i,s){const o=this.getHeightOfLine(e),r=this.textAlign.includes(h),a=this._textLines[e];let l,g,c,m,f,d="",p=0;s+=o*(1-this._fontSizeFraction)/this.lineHeight;for(let o=0,h=a.length-1;o<=h;o++)f=o===h||this.charSpacing||this.path,d+=a[o],c=this.__charBounds[e][o],0===p?(i+=c.kernedWidth-c.width,p+=c.width):p+=c.kernedWidth,r&&!f&&this._reSpaceAndTab.test(a[o])&&(f=!0),f||(l=l||this.getCompleteStyleDeclaration(e,o),g=this.getCompleteStyleDeclaration(e,o+1),f=n(l,g,!0)),f&&(m=this._getStyleDeclaration(e,o),t.push(this._createTextCharSpan(d,m,i,s,c)),d="",l=g,"rtl"===this.direction?i-=p:i+=p,p=0)}_setSVGTextLineBg(t,e,i,s){const n=this._textLines[e],o=this.getHeightOfLine(e)/this.lineHeight;let r,h=0,a=0,l=this.getValueOfPropertyAt(e,0,"textBackgroundColor");for(let g=0;g<n.length;g++){const{left:n,width:c,kernedWidth:m}=this.__charBounds[e][g];r=this.getValueOfPropertyAt(e,g,"textBackgroundColor"),r!==l?(l&&t.push(...S(l,i+a,s,h,o)),a=n,h=c,l=r):h+=m}r&&t.push(...S(l,i+a,s,h,o))}getSvgStyles(t){return`${super.getSvgStyles(t)} white-space: pre;`}getSvgSpanStyles(t,e){const{fontFamily:s,strokeWidth:n,stroke:o,fill:r,fontSize:h,fontStyle:g,fontWeight:c,deltaY:m}=t,f=this.getSvgTextDecoration(t);return[o?i(a,o):"",n?`stroke-width: ${n}; `:"",s?`font-family: ${s.includes("'")||s.includes('"')?s:`'${s}'`}; `:"",h?`font-size: ${h}px; `:"",g?`font-style: ${g}; `:"",c?`font-weight: ${c}; `:"",f?`text-decoration: ${f}; `:f,r?i(l,r):"",m?`baseline-shift: ${-m}; `:"",e?"white-space: pre; ":""].join("")}getSvgTextDecoration(t){return["overline","underline","line-through"].filter((e=>t[e.replace("-","")])).join(" ")}}export{x as TextSVGExportMixin};
//# sourceMappingURL=TextSVGExportMixin.min.mjs.map
