import{defineProperty as t}from"../../../_virtual/_rollupPluginBabelHelpers.min.mjs";import{cache as e}from"../../cache.min.mjs";import{STROKE as i,BOTTOM as s,TOP as n,CENTER as r,RTL as h,RIGHT as o,LTR as l,FILL as a,LEFT as f,DEFAULT_SVG_FONT_SIZE as d}from"../../constants.min.mjs";import{StyledText as c}from"./StyledText.min.mjs";import{SHARED_ATTRIBUTES as g}from"../../parser/attributes.min.mjs";import{parseAttributes as p}from"../../parser/parseAttributes.min.mjs";import{classRegistry as u}from"../../ClassRegistry.min.mjs";import{graphemeSplit as _}from"../../util/lang_string.min.mjs";import{createCanvasElementFor as m}from"../../util/misc/dom.min.mjs";import{hasStyleChanged as x,stylesToArray as S,stylesFromArray as y}from"../../util/misc/textStyles.min.mjs";import{getPathSegmentsInfo as T,getPointOnPath as L}from"../../util/path/index.min.mjs";import"../Object/FabricObject.min.mjs";import{TextSVGExportMixin as O}from"./TextSVGExportMixin.min.mjs";import{applyMixins as C}from"../../util/applyMixins.min.mjs";import{textLayoutProperties as w,additionalProps as k,textDefaultValues as W,JUSTIFY as D,JUSTIFY_CENTER as v,JUSTIFY_RIGHT as A,JUSTIFY_LEFT as F,TEXT_DECORATION_THICKNESS as H}from"./constants.min.mjs";import{isFiller as P}from"../../util/typeAssertions.min.mjs";import{normalizeWs as I}from"../../util/internals/normalizeWhiteSpace.min.mjs";import{cacheProperties as b}from"../Object/defaultValues.min.mjs";let j;class B extends c{static getDefaults(){return{...super.getDefaults(),...B.ownDefaults}}constructor(e,i){super(),t(this,"__charBounds",[]),Object.assign(this,B.ownDefaults),this.setOptions(i),this.styles||(this.styles={}),this.text=e,this.initialized=!0,this.path&&this.setPathInfo(),this.initDimensions(),this.setCoords()}setPathInfo(){const t=this.path;t&&(t.segmentsInfo=T(t.path))}_splitText(){const t=this._splitTextIntoLines(this.text);return this.textLines=t.lines,this._textLines=t.graphemeLines,this._unwrappedTextLines=t._unwrappedLines,this._text=t.graphemeText,t}initDimensions(){this._splitText(),this._clearCache(),this.dirty=!0,this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.includes(D)&&this.enlargeSpaces()}enlargeSpaces(){let t,e,i,s,n,r,h;for(let o=0,l=this._textLines.length;o<l;o++)if((this.textAlign===D||o!==l-1&&!this.isEndOfWrapping(o))&&(s=0,n=this._textLines[o],e=this.getLineWidth(o),e<this.width&&(h=this.textLines[o].match(this._reSpacesAndTabs)))){i=h.length,t=(this.width-e)/i;for(let e=0;e<=n.length;e++)r=this.__charBounds[o][e],this._reSpaceAndTab.test(n[e])?(r.width+=t,r.kernedWidth+=t,r.left+=s,s+=t):r.left+=s}}isEndOfWrapping(t){return t===this._textLines.length-1}missingNewlineOffset(t){return 1}get2DCursorLocation(t,e){const i=e?this._unwrappedTextLines:this._textLines;let s;for(s=0;s<i.length;s++){if(t<=i[s].length)return{lineIndex:s,charIndex:t};t-=i[s].length+this.missingNewlineOffset(s,e)}return{lineIndex:s-1,charIndex:i[s-1].length<t?i[s-1].length:t}}toString(){return`#<Text (${this.complexity()}): { "text": "${this.text}", "fontFamily": "${this.fontFamily}" }>`}_getCacheCanvasDimensions(){const t=super._getCacheCanvasDimensions(),e=this.fontSize;return t.width+=e*t.zoomX,t.height+=e*t.zoomY*this.cacheExpansionFactor,t}_render(t){const e=this.path;e&&!e.isNotVisible()&&e._render(t),this._setTextStyles(t),this._renderTextLinesBackground(t),this._renderTextDecoration(t,"underline"),this._renderText(t),this._renderTextDecoration(t,"overline"),this._renderTextDecoration(t,"linethrough"),this._renderTextDecoration(t,"squigglyline")}_renderText(t){this.paintFirst===i?(this._renderTextStroke(t),this._renderTextFill(t)):(this._renderTextFill(t),this._renderTextStroke(t))}_setTextStyles(t,e,i){if(t.textBaseline="alphabetic",this.path)switch(this.pathAlign){case r:t.textBaseline="middle";break;case"ascender":t.textBaseline=n;break;case"descender":t.textBaseline=s}t.font=this._getFontDeclaration(e,i)}calcTextWidth(){let t=this.getLineWidth(0);for(let e=1,i=this._textLines.length;e<i;e++){const i=this.getLineWidth(e);i>t&&(t=i)}return t}_renderTextLine(t,e,i,s,n,r){this._renderChars(t,e,i,s,n,r)}_renderTextLinesBackground(t){if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))return;const e=t.fillStyle,i=this._getLeftOffset();let s=this._getTopOffset();for(let e=0,n=this._textLines.length;e<n;e++){const n=this.getHeightOfLine(e);if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",e)){s+=n;continue}const r=this._textLines[e].length,o=this._getLineLeftOffset(e);let l,a,f=0,d=0,c=this.getValueOfPropertyAt(e,0,"textBackgroundColor");const g=this.getHeightOfLineImpl(e);for(let n=0;n<r;n++){const r=this.__charBounds[e][n];a=this.getValueOfPropertyAt(e,n,"textBackgroundColor"),this.path?(t.save(),t.translate(r.renderLeft,r.renderTop),t.rotate(r.angle),t.fillStyle=a,a&&t.fillRect(-r.width/2,-g*(1-this._fontSizeFraction),r.width,g),t.restore()):a!==c?(l=i+o+d,this.direction===h&&(l=this.width-l-f),t.fillStyle=c,c&&t.fillRect(l,s,f,g),d=r.left,f=r.width,c=a):f+=r.kernedWidth}a&&!this.path&&(l=i+o+d,this.direction===h&&(l=this.width-l-f),t.fillStyle=a,t.fillRect(l,s,f,g)),s+=n}t.fillStyle=e,this._removeShadow(t)}_measureChar(t,i,s,n){const r=e.getFontCache(i),h=this._getFontDeclaration(i),o=s?s+t:t,l=s&&h===this._getFontDeclaration(n),a=i.fontSize/this.CACHE_FONT_SIZE;let f,d,c,g;if(s&&r.has(s)&&(c=r.get(s)),r.has(t)&&(g=f=r.get(t)),l&&r.has(o)&&(d=r.get(o),g=d-c),void 0===f||void 0===c||void 0===d){const e=function(){if(!j){const t=m({width:0,height:0});j=t.getContext("2d")}return j}();this._setTextStyles(e,i,!0),void 0===f&&(g=f=e.measureText(t).width,r.set(t,f)),void 0===c&&l&&s&&(c=e.measureText(s).width,r.set(s,c)),l&&void 0===d&&(d=e.measureText(o).width,r.set(o,d),g=d-c)}return{width:f*a,kernedWidth:g*a}}getHeightOfChar(t,e){return this.getValueOfPropertyAt(t,e,"fontSize")}measureLine(t){const e=this._measureLine(t);return 0!==this.charSpacing&&(e.width-=this._getWidthOfCharSpacing()),e.width<0&&(e.width=0),e}_measureLine(t){let e,i,s=0;const n=this.pathSide===o,h=this.path,l=this._textLines[t],a=l.length,d=new Array(a);this.__charBounds[t]=d;for(let n=0;n<a;n++){const r=l[n];i=this._getGraphemeBox(r,t,n,e),d[n]=i,s+=i.kernedWidth,e=r}if(d[a]={left:i?i.left+i.width:0,width:0,kernedWidth:0,height:this.fontSize,deltaY:0},h&&h.segmentsInfo){let t=0;const e=h.segmentsInfo[h.segmentsInfo.length-1].length;switch(this.textAlign){case f:t=n?e-s:0;break;case r:t=(e-s)/2;break;case o:t=n?0:e-s}t+=this.pathStartOffset*(n?-1:1);for(let s=n?a-1:0;n?s>=0:s<a;n?s--:s++)i=d[s],t>e?t%=e:t<0&&(t+=e),this._setGraphemeOnPath(t,i),t+=i.kernedWidth}return{width:s,numOfSpaces:0}}_setGraphemeOnPath(t,e){const i=t+e.kernedWidth/2,s=this.path,n=L(s.path,i,s.segmentsInfo);e.renderLeft=n.x-s.pathOffset.x,e.renderTop=n.y-s.pathOffset.y,e.angle=n.angle+(this.pathSide===o?Math.PI:0)}_getGraphemeBox(t,e,i,s,n){const r=this.getCompleteStyleDeclaration(e,i),h=s?this.getCompleteStyleDeclaration(e,i-1):{},o=this._measureChar(t,r,s,h);let l,a=o.kernedWidth,f=o.width;0!==this.charSpacing&&(l=this._getWidthOfCharSpacing(),f+=l,a+=l);const d={width:f,left:0,height:r.fontSize,kernedWidth:a,deltaY:r.deltaY};if(i>0&&!n){const t=this.__charBounds[e][i-1];d.left=t.left+t.width+o.kernedWidth-o.width}return d}getHeightOfLineImpl(t){const e=this.__lineHeights;if(e[t])return e[t];let i=this.getHeightOfChar(t,0);for(let e=1,s=this._textLines[t].length;e<s;e++)i=Math.max(this.getHeightOfChar(t,e),i);return e[t]=i*this._fontSizeMult}getHeightOfLine(t){return this.getHeightOfLineImpl(t)*this.lineHeight}calcTextHeight(){let t,e=0;for(let i=0,s=this._textLines.length;i<s;i++)t=this.getHeightOfLine(i),e+=i===s-1&&this.lineHeight<1?t/this.lineHeight:t;return e}_getLeftOffset(){return this.direction===l?-this.width/2:this.width/2}_getTopOffset(){return-this.height/2}_renderTextCommon(t,e){t.save();let i=0;const s=this._getLeftOffset(),n=this._getTopOffset();for(let r=0,h=this._textLines.length;r<h;r++)this._renderTextLine(e,t,this._textLines[r],s+this._getLineLeftOffset(r),n+i+this.getHeightOfLineImpl(r),r),i+=this.getHeightOfLine(r);t.restore()}_renderTextFill(t){(this.fill||this.styleHas(a))&&this._renderTextCommon(t,"fillText")}_renderTextStroke(t){(this.stroke&&0!==this.strokeWidth||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this._setLineDash(t,this.strokeDashArray),t.beginPath(),this._renderTextCommon(t,"strokeText"),t.closePath(),t.restore())}_renderChars(t,e,i,s,n,r){const a=this.textAlign.includes(D),d=this.path,c=!a&&0===this.charSpacing&&this.isEmptyStyles(r)&&!d,g=this.direction===l,p=this.direction===l?1:-1,u=e.direction;let _,m,S,y,T,L="",O=0;if(e.save(),u!==this.direction&&(e.canvas.setAttribute("dir",g?l:h),e.direction=g?l:h,e.textAlign=g?f:o),n-=this.getHeightOfLineImpl(r)*this._fontSizeFraction,c)return this._renderChar(t,e,r,0,i.join(""),s,n),void e.restore();for(let h=0,o=i.length-1;h<=o;h++)y=h===o||this.charSpacing||d,L+=i[h],S=this.__charBounds[r][h],0===O?(s+=p*(S.kernedWidth-S.width),O+=S.width):O+=S.kernedWidth,a&&!y&&this._reSpaceAndTab.test(i[h])&&(y=!0),y||(_=_||this.getCompleteStyleDeclaration(r,h),m=this.getCompleteStyleDeclaration(r,h+1),y=x(_,m,!1)),y&&(d?(e.save(),e.translate(S.renderLeft,S.renderTop),e.rotate(S.angle),this._renderChar(t,e,r,h,L,-O/2,0),e.restore()):(T=s,this._renderChar(t,e,r,h,L,T,n)),L="",_=m,s+=p*O,O=0);e.restore()}_applyPatternGradientTransformText(t){const e=this.width+this.strokeWidth,i=this.height+this.strokeWidth,s=m({width:e,height:i}),n=s.getContext("2d");return s.width=e,s.height=i,n.beginPath(),n.moveTo(0,0),n.lineTo(e,0),n.lineTo(e,i),n.lineTo(0,i),n.closePath(),n.translate(e/2,i/2),n.fillStyle=t.toLive(n),this._applyPatternGradientTransform(n,t),n.fill(),n.createPattern(s,"no-repeat")}handleFiller(t,e,i){let s,n;return P(i)?"percentage"===i.gradientUnits||i.gradientTransform||i.patternTransform?(s=-this.width/2,n=-this.height/2,t.translate(s,n),t[e]=this._applyPatternGradientTransformText(i),{offsetX:s,offsetY:n}):(t[e]=i.toLive(t),this._applyPatternGradientTransform(t,i)):(t[e]=i,{offsetX:0,offsetY:0})}_setStrokeStyles(t,e){let{stroke:i,strokeWidth:s}=e;return t.lineWidth=s,t.lineCap=this.strokeLineCap,t.lineDashOffset=this.strokeDashOffset,t.lineJoin=this.strokeLineJoin,t.miterLimit=this.strokeMiterLimit,this.handleFiller(t,"strokeStyle",i)}_setFillStyles(t,e){let{fill:i}=e;return this.handleFiller(t,"fillStyle",i)}_renderChar(t,e,i,s,n,r,h){const o=this._getStyleDeclaration(i,s),l=this.getCompleteStyleDeclaration(i,s),a="fillText"===t&&l.fill,f="strokeText"===t&&l.stroke&&l.strokeWidth;if(f||a){if(e.save(),e.font=this._getFontDeclaration(l),o.textBackgroundColor&&this._removeShadow(e),o.deltaY&&(h+=o.deltaY),a){const t=this._setFillStyles(e,l);e.fillText(n,r-t.offsetX,h-t.offsetY)}if(f){const t=this._setStrokeStyles(e,l);e.strokeText(n,r-t.offsetX,h-t.offsetY)}e.restore()}}setSuperscript(t,e){this._setScript(t,e,this.superscript)}setSubscript(t,e){this._setScript(t,e,this.subscript)}_setScript(t,e,i){const s=this.get2DCursorLocation(t,!0),n=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"fontSize"),r=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"deltaY"),h={fontSize:n*i.size,deltaY:r+n*i.baseline};this.setSelectionStyles(h,t,e)}_getLineLeftOffset(t){const e=this.getLineWidth(t),i=this.width-e,s=this.textAlign,n=this.direction,l=this.isEndOfWrapping(t);let a=0;return s===D||s===v&&!l||s===A&&!l||s===F&&!l?0:(s===r&&(a=i/2),s===o&&(a=i),s===v&&(a=i/2),s===A&&(a=i),n===h&&(s===o||s===A?a=0:s===f||s===F?a=-i:s!==r&&s!==v||(a=-i/2)),a)}_clearCache(){this._forceClearCache=!1,this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]}getLineWidth(t){if(void 0!==this.__lineWidths[t])return this.__lineWidths[t];const{width:e}=this.measureLine(t);return this.__lineWidths[t]=e,e}_getWidthOfCharSpacing(){return this.charSpacing}getValueOfPropertyAt(t,e,i){var s;return null!==(s=this._getStyleDeclaration(t,e)[i])&&void 0!==s?s:this[i]}_renderTextDecoration(t,e){if(!this[e]&&!this.styleHas(e))return;let i=this._getTopOffset();const s=this._getLeftOffset(),n=this.path,r=this._getWidthOfCharSpacing(),o="linethrough"===e?.5:"overline"===e?1:0,l=this.offsets[e];for(let f=0,d=this._textLines.length;f<d;f++){const d=this.getHeightOfLine(f);if(!this[e]&&!this.styleHas(e,f)){i+=d;continue}const c=this._textLines[f],g=d/this.lineHeight,p=this._getLineLeftOffset(f);let u=0,_=0,m=this.getValueOfPropertyAt(f,0,e),x=this.getValueOfPropertyAt(f,0,a),S=this.getValueOfPropertyAt(f,0,H),y=m,T=x,L=S;const O=i+g*(1-this._fontSizeFraction);let C=this.getHeightOfChar(f,0),w=this.getValueOfPropertyAt(f,0,"deltaY");for(let i=0,r=c.length;i<r;i++){const r=this.__charBounds[f][i];y=this.getValueOfPropertyAt(f,i,e),T=this.getValueOfPropertyAt(f,i,a),L=this.getValueOfPropertyAt(f,i,H);const d=this.getHeightOfChar(f,i),c=this.getValueOfPropertyAt(f,i,"deltaY");if(n&&y&&T){const i=this.fontSize*L/1e3;t.save(),t.fillStyle=this.getFillForTextDecoration(t,e,x),t.translate(r.renderLeft,r.renderTop),t.rotate(r.angle),this.fillTextDecorationRect(t,e,-r.kernedWidth/2,l*d+c-o*i,r.kernedWidth,i),t.restore()}else if((y!==m||T!==x||d!==C||L!==S||c!==w)&&_>0){const i=this.fontSize*S/1e3;let n=s+p+u;this.direction===h&&(n=this.width-n-_),m&&x&&S&&(t.fillStyle=this.getFillForTextDecoration(t,e,x),this.fillTextDecorationRect(t,e,n,O+l*C+w-o*i,_,i)),u=r.left,_=r.width,m=y,S=L,x=T,C=d,w=c}else _+=r.kernedWidth}let k=s+p+u;this.direction===h&&(k=this.width-k-_),t.fillStyle=this.getFillForTextDecoration(t,e,T);const W=this.fontSize*L/1e3;y&&T&&L&&this.fillTextDecorationRect(t,e,k,O+l*C+w-o*W,_-r,W),i+=d}}fillTextDecorationRect(t,e,i,s,n,r){if("squigglyline"===e){const e=[],r=.35,h=.45,o=function(t){const e=t%6;return e<=3?5*e:5*(6-e)};for(let t=0;t<n;t+=.5)e.push({x:t-10,y:o(t*r)*h});for(let n=0;n<e.length;n++)t.fillRect(i+e[n].x+8,s+e[n].y,2,2)}else t.fillRect(i,s,n,r)}getFillForTextDecoration(t,e,i){if("squigglyline"===e)return this.squigglylineColor;if(i&&"string"!=typeof i&&"colorStops"in i&&i.colorStops.length)return i.colorStops[0].color;if(i&&"string"!=typeof i&&"source"in i){const e=t.createPattern(i.source,"repeat");if(e)return e}return i}_renderBackground(t){if(!this.backgroundColor)return;const e=this._getNonTransformedDimensions();let i=this.scaleX,s=this.scaleY;t.fillStyle=this.backgroundColor,this.group&&(i*=this.group.scaleX,s*=this.group.scaleY),t.fillRect(-e.x/2-this.padding/i,-e.y/2-this.padding/s,e.x+this.padding/i*2,e.y+this.padding/s*2),this._removeShadow(t)}getCharOffset(t){let e=0,i=0;const s=this.get2DCursorLocation(t),n=s.charIndex,r=s.lineIndex;for(let t=0;t<r;t++)e+=this.getHeightOfLine(t);const h=this._getLineLeftOffset(r),o=this.__charBounds[r][n];return o&&(i=o.left),0!==this.charSpacing&&n===this._textLines[r].length&&(i-=this._getWidthOfCharSpacing()),{x:h+(i>0?i:0),y:e}}findSelectedWordLeft(t){let e=0,i=t-1;for(;/[^\n -&(-/:-@[-`{-~0-9]/.test(this._text[i])&&i>-1;)e++,i--;return t-e}findSelectedWordRight(t){let e=0,i=t;for(;/[^\n -&(-/:-@[-`{-~0-9]/.test(this._text[i])&&i<this._text.length;)e++,i++;return t+e}_getFontDeclaration(){let{fontFamily:t=this.fontFamily,fontStyle:e=this.fontStyle,fontWeight:i=this.fontWeight,fontSize:s=this.fontSize}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0;const r=t.includes("'")||t.includes('"')||t.includes(",")||B.genericFonts.includes(t.toLowerCase())?t:`"${t}"`;return[e,i,`${n?this.CACHE_FONT_SIZE:s}px`,r].join(" ")}render(t){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._forceClearCache&&this.initDimensions(),super.render(t)))}graphemeSplit(t){return _(t)}_splitTextIntoLines(t){const e=t.split(this._reNewline),i=new Array(e.length),s=["\n"];let n=[];for(let t=0;t<e.length;t++)i[t]=this.graphemeSplit(e[t]),n=n.concat(i[t],s);return n.pop(),{_unwrappedLines:i,lines:e,graphemeText:n,graphemeLines:i}}toObject(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return{...super.toObject([...k,...t]),styles:S(this.styles,this.text),...this.path?{path:this.path.toObject()}:{}}}set(t,e){const{textLayoutProperties:i}=this.constructor;super.set(t,e);let s=!1,n=!1;if("object"==typeof t)for(const e in t)"path"===e&&this.setPathInfo(),s=s||i.includes(e),n=n||"path"===e;else s=i.includes(t),n="path"===t;return n&&this.setPathInfo(),s&&this.initialized&&(this.initDimensions(),this.setCoords()),this}complexity(){return 1}static async fromElement(t,e,i){const s=p(t,B.ATTRIBUTE_NAMES,i),{textAnchor:n=f,textDecoration:h="",dx:l=0,dy:a=0,top:c=0,left:g=0,fontSize:u=d,strokeWidth:_=1,...m}={...e,...s},x=new this(I(t.textContent||"").trim(),{left:g+l,top:c+a,underline:h.includes("underline"),overline:h.includes("overline"),linethrough:h.includes("line-through"),squigglyline:h.includes("squiggly-line"),strokeWidth:0,fontSize:u,...m}),S=x.getScaledHeight()/x.height,y=((x.height+x.strokeWidth)*x.lineHeight-x.height)*S,T=x.getScaledHeight()+y;let L=0;return n===r&&(L=x.getScaledWidth()/2),n===o&&(L=x.getScaledWidth()),x.set({left:x.left-L,top:x.top-(T-x.fontSize*(.07+x._fontSizeFraction))/x.lineHeight,strokeWidth:_}),x}static fromObject(t){return this._fromObject({...t,styles:y(t.styles||{},t.text||"")},{extraParam:"text"})}}t(B,"textLayoutProperties",w),t(B,"cacheProperties",[...b,...k]),t(B,"ownDefaults",W),t(B,"type","Text"),t(B,"genericFonts",["serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),t(B,"ATTRIBUTE_NAMES",g.concat("x","y","dx","dy","font-family","font-style","font-weight","font-size","letter-spacing","text-decoration","text-anchor")),C(B,[O]),u.setClass(B),u.setSVGClass(B);export{B as FabricText};
//# sourceMappingURL=Text.min.mjs.map
