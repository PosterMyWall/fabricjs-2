{"version":3,"file":"IText.mjs","sources":["../../../../src/shapes/IText/IText.ts"],"sourcesContent":["import { Canvas } from '../../canvas/Canvas';\nimport type { ITextEvents } from './ITextBehavior';\nimport { ITextClickBehavior } from './ITextClickBehavior';\nimport {\n  ctrlKeysMapDown,\n  ctrlKeysMapUp,\n  keysMap,\n  keysMapRtl,\n} from './constants';\nimport type { TClassProperties, TFiller, TOptions } from '../../typedefs';\nimport { classRegistry } from '../../ClassRegistry';\nimport type { SerializedTextProps, TextProps } from '../Text/Text';\nimport {\n  JUSTIFY,\n  JUSTIFY_CENTER,\n  JUSTIFY_LEFT,\n  JUSTIFY_RIGHT,\n} from '../Text/constants';\nimport { CENTER, FILL, LEFT, RIGHT } from '../../constants';\nimport type { ObjectToCanvasElementOptions } from '../Object/Object';\n\nexport type CursorBoundaries = {\n  left: number;\n  top: number;\n  leftOffset: number;\n  topOffset: number;\n};\n\nexport type CursorRenderingData = {\n  color: string;\n  opacity: number;\n  left: number;\n  top: number;\n  width: number;\n  height: number;\n};\n\n// Declare IText protected properties to workaround TS\nconst protectedDefaultValues = {\n  _selectionDirection: null,\n  _reSpace: /\\s|\\r?\\n/,\n  inCompositionMode: false,\n};\n\nexport const iTextDefaultValues: Partial<TClassProperties<IText>> = {\n  selectionStart: 0,\n  selectionEnd: 0,\n  selectionColor: 'rgba(17,119,255,0.3)',\n  isEditing: false,\n  editable: true,\n  column: 0,\n  dataType: '',\n  editingBorderColor: 'rgba(102,153,255,0.25)',\n  cursorWidth: 2,\n  cursorColor: '',\n  cursorDelay: 1000,\n  cursorDuration: 600,\n  caching: true,\n  hiddenTextareaContainer: null,\n  keysMap,\n  keysMapRtl,\n  ctrlKeysMapDown,\n  ctrlKeysMapUp,\n  ...protectedDefaultValues,\n};\n\n// @TODO this is not complete\ninterface UniqueITextProps {\n  selectionStart: number;\n  selectionEnd: number;\n}\n\nexport interface SerializedITextProps\n  extends SerializedTextProps,\n    UniqueITextProps {}\n\nexport interface ITextProps extends TextProps, UniqueITextProps {}\n\n/**\n * @fires changed\n * @fires selection:changed\n * @fires editing:entered\n * @fires editing:exited\n * @fires dragstart\n * @fires drag drag event firing on the drag source\n * @fires dragend\n * @fires copy\n * @fires cut\n * @fires paste\n *\n * #### Supported key combinations\n * ```\n *   Move cursor:                    left, right, up, down\n *   Select character:               shift + left, shift + right\n *   Select text vertically:         shift + up, shift + down\n *   Move cursor by word:            alt + left, alt + right\n *   Select words:                   shift + alt + left, shift + alt + right\n *   Move cursor to line start/end:  cmd + left, cmd + right or home, end\n *   Select till start/end of line:  cmd + shift + left, cmd + shift + right or shift + home, shift + end\n *   Jump to start/end of text:      cmd + up, cmd + down\n *   Select till start/end of text:  cmd + shift + up, cmd + shift + down or shift + pgUp, shift + pgDown\n *   Delete character:               backspace\n *   Delete word:                    alt + backspace\n *   Delete line:                    cmd + backspace\n *   Forward delete:                 delete\n *   Copy text:                      ctrl/cmd + c\n *   Paste text:                     ctrl/cmd + v\n *   Cut text:                       ctrl/cmd + x\n *   Select entire text:             ctrl/cmd + a\n *   Quit editing                    tab or esc\n * ```\n *\n * #### Supported mouse/touch combination\n * ```\n *   Position cursor:                click/touch\n *   Create selection:               click/touch & drag\n *   Create selection:               click & shift + click\n *   Select word:                    double click\n *   Select line:                    triple click\n * ```\n */\nexport class IText<\n    Props extends TOptions<ITextProps> = Partial<ITextProps>,\n    SProps extends SerializedITextProps = SerializedITextProps,\n    EventSpec extends ITextEvents = ITextEvents,\n  >\n  extends ITextClickBehavior<Props, SProps, EventSpec>\n  implements UniqueITextProps\n{\n  /**\n   * Index where text selection starts (or where cursor is when there is no selection)\n   * @type Number\n   * @default\n   */\n  declare selectionStart: number;\n\n  /**\n   * Index where text selection ends\n   * @type Number\n   * @default\n   */\n  declare selectionEnd: number;\n\n  declare compositionStart: number;\n\n  declare compositionEnd: number;\n\n  /**\n   * Color of text selection\n   * @type String\n   * @default\n   */\n  declare selectionColor: string;\n\n  declare column: number;\n  declare dataType: string;\n\n  /**\n   * Indicates whether text is in editing mode\n   * @type Boolean\n   * @default\n   */\n  declare isEditing: boolean;\n\n  /**\n   * Indicates whether a text can be edited\n   * @type Boolean\n   * @default\n   */\n  declare editable: boolean;\n\n  /**\n   * Border color of text object while it's in editing mode\n   * @type String\n   * @default\n   */\n  declare editingBorderColor: string;\n\n  /**\n   * Width of cursor (in px)\n   * @type Number\n   * @default\n   */\n  declare cursorWidth: number;\n\n  /**\n   * Color of text cursor color in editing mode.\n   * if not set (default) will take color from the text.\n   * if set to a color value that fabric can understand, it will\n   * be used instead of the color of the text at the current position.\n   * @type String\n   * @default\n   */\n  declare cursorColor: string;\n\n  /**\n   * Delay between cursor blink (in ms)\n   * @type Number\n   * @default\n   */\n  declare cursorDelay: number;\n\n  /**\n   * Duration of cursor fade in (in ms)\n   * @type Number\n   * @default\n   */\n  declare cursorDuration: number;\n\n  declare compositionColor: string;\n\n  /**\n   * Indicates whether internal text char widths can be cached\n   * @type Boolean\n   * @default\n   */\n  declare caching: boolean;\n\n  static ownDefaults = iTextDefaultValues;\n\n  static getDefaults(): Record<string, any> {\n    return { ...super.getDefaults(), ...IText.ownDefaults };\n  }\n\n  static type = 'IText';\n\n  get type() {\n    const type = super.type;\n    // backward compatibility\n    return type === 'itext' ? 'i-text' : type;\n  }\n\n  /**\n   * Constructor\n   * @param {String} text Text string\n   * @param {Object} [options] Options object\n   */\n  constructor(text: string, options?: Props) {\n    super(text, { ...IText.ownDefaults, ...options } as Props);\n    this.initBehavior();\n  }\n\n  /**\n   * While editing handle differently\n   * @private\n   * @param {string} key\n   * @param {*} value\n   */\n  _set(key: string, value: any) {\n    if (this.isEditing && this._savedProps && key in this._savedProps) {\n      // @ts-expect-error irritating TS\n      this._savedProps[key] = value;\n      return this;\n    }\n    if (key === 'canvas') {\n      this.canvas instanceof Canvas &&\n        this.canvas.textEditingManager.remove(this);\n      value instanceof Canvas && value.textEditingManager.add(this);\n    }\n    return super._set(key, value);\n  }\n\n  /**\n   * Sets selection start (left boundary of a selection)\n   * @param {Number} index Index to set selection start to\n   */\n  setSelectionStart(index: number) {\n    index = Math.max(index, 0);\n    this._updateAndFire('selectionStart', index);\n  }\n\n  /**\n   * Sets selection end (right boundary of a selection)\n   * @param {Number} index Index to set selection end to\n   */\n  setSelectionEnd(index: number) {\n    index = Math.min(index, this.text.length);\n    this._updateAndFire('selectionEnd', index);\n  }\n\n  /**\n   * @private\n   * @param {String} property 'selectionStart' or 'selectionEnd'\n   * @param {Number} index new position of property\n   */\n  protected _updateAndFire(\n    property: 'selectionStart' | 'selectionEnd',\n    index: number,\n  ) {\n    if (this[property] !== index) {\n      this._fireSelectionChanged();\n      this[property] = index;\n    }\n    this._updateTextarea();\n  }\n\n  /**\n   * *PMW*\n   * Returns location of cursor on canvas\n   */\n  getCharOffset(position: number) {\n    let topOffset = 0,\n      leftOffset = 0;\n    const cursorPosition = this.get2DCursorLocation(position),\n      charIndex = cursorPosition.charIndex,\n      lineIndex = cursorPosition.lineIndex;\n    for (let i = 0; i < lineIndex; i++) {\n      topOffset += this.getHeightOfLine(i);\n    }\n    const lineLeftOffset = this._getLineLeftOffset(lineIndex);\n    const bound = this.__charBounds[lineIndex][charIndex];\n    bound && (leftOffset = bound.left);\n    if (\n      this.charSpacing !== 0 &&\n      charIndex === this._textLines[lineIndex].length\n    ) {\n      leftOffset -= this._getWidthOfCharSpacing();\n    }\n    return {\n      x: lineLeftOffset + (leftOffset > 0 ? leftOffset : 0),\n      y: topOffset,\n    };\n  }\n\n  /**\n   * *PMW*\n   * Draws a background for the object big as its untrasformed dimensions\n   * @private\n   */\n  _renderBackground(ctx: CanvasRenderingContext2D) {\n    if (!this.backgroundColor) {\n      return;\n    }\n    const dim = this._getNonTransformedDimensions();\n    let scaleX = this.scaleX,\n      scaleY = this.scaleY;\n\n    ctx.fillStyle = this.backgroundColor;\n    if (this.group) {\n      scaleX *= this.group.scaleX;\n      scaleY *= this.group.scaleY;\n    }\n\n    ctx.fillRect(\n      -dim.x / 2 - this.padding / scaleX,\n      -dim.y / 2 - this.padding / scaleY,\n      dim.x + (this.padding / scaleX) * 2,\n      dim.y + (this.padding / scaleY) * 2\n    );\n    // if there is background color no other shadows\n    // should be casted\n    this._removeShadow(ctx);\n  }\n\n  /**\n   * Fires the even of selection changed\n   * @private\n   */\n  _fireSelectionChanged() {\n    this.fire('selection:changed');\n    this.canvas && this.canvas.fire('text:selection:changed', { target: this });\n  }\n\n  /**\n   * Initialize text dimensions. Render all text on given context\n   * or on a offscreen canvas to get the text width with measureText.\n   * Updates this.width and this.height with the proper values.\n   * Does not return dimensions.\n   * @private\n   */\n  initDimensions() {\n    this.isEditing && this.initDelayedCursor();\n    super.initDimensions();\n  }\n\n  /**\n   * Gets style of a current selection/cursor (at the start position)\n   * if startIndex or endIndex are not provided, selectionStart or selectionEnd will be used.\n   * @param {Number} startIndex Start index to get styles at\n   * @param {Number} endIndex End index to get styles at, if not specified selectionEnd or startIndex + 1\n   * @param {Boolean} [complete] get full style or not\n   * @return {Array} styles an array with one, zero or more Style objects\n   */\n  getSelectionStyles(\n    startIndex: number = this.selectionStart || 0,\n    endIndex: number = this.selectionEnd,\n    complete?: boolean,\n  ) {\n    return super.getSelectionStyles(startIndex, endIndex, complete);\n  }\n\n  /**\n   * Sets style of a current selection, if no selection exist, do not set anything.\n   * @param {Object} [styles] Styles object\n   * @param {Number} [startIndex] Start index to get styles at\n   * @param {Number} [endIndex] End index to get styles at, if not specified selectionEnd or startIndex + 1\n   */\n  setSelectionStyles(\n    styles: object,\n    startIndex: number = this.selectionStart || 0,\n    endIndex: number = this.selectionEnd,\n  ) {\n    return super.setSelectionStyles(styles, startIndex, endIndex);\n  }\n\n  /**\n   * Returns 2d representation (lineIndex and charIndex) of cursor (or selection start)\n   * @param {Number} [selectionStart] Optional index. When not given, current selectionStart is used.\n   * @param {Boolean} [skipWrapping] consider the location for unwrapped lines. useful to manage styles.\n   */\n  get2DCursorLocation(\n    selectionStart = this.selectionStart,\n    skipWrapping?: boolean,\n  ) {\n    return super.get2DCursorLocation(selectionStart, skipWrapping);\n  }\n\n  /**\n   * @private\n   * @param {CanvasRenderingContext2D} ctx Context to render on\n   */\n  render(ctx: CanvasRenderingContext2D) {\n    super.render(ctx);\n    // clear the cursorOffsetCache, so we ensure to calculate once per renderCursor\n    // the correct position but not at every cursor animation.\n    this.cursorOffsetCache = {};\n    this.renderCursorOrSelection();\n  }\n\n  /**\n   * @override block cursor/selection logic while rendering the exported canvas\n   * @todo this workaround should be replaced with a more robust solution\n   */\n  toCanvasElement(options?: ObjectToCanvasElementOptions): HTMLCanvasElement {\n    const isEditing = this.isEditing;\n    this.isEditing = false;\n    const canvas = super.toCanvasElement(options);\n    this.isEditing = isEditing;\n    return canvas;\n  }\n\n  /**\n   * Renders cursor or selection (depending on what exists)\n   * it does on the contextTop. If contextTop is not available, do nothing.\n   */\n  renderCursorOrSelection() {\n    if (!this.isEditing) {\n      return;\n    }\n    const ctx = this.clearContextTop(true);\n    if (!ctx) {\n      return;\n    }\n    const boundaries = this._getCursorBoundaries();\n    if (this.selectionStart === this.selectionEnd && !this.inCompositionMode) {\n      this.renderCursor(ctx, boundaries);\n    } else {\n      this.renderSelection(ctx, boundaries);\n    }\n    this.canvas!.contextTopDirty = true;\n    ctx.restore();\n  }\n\n  /**\n   * Returns cursor boundaries (left, top, leftOffset, topOffset)\n   * left/top are left/top of entire text box\n   * leftOffset/topOffset are offset from that left/top point of a text box\n   * @private\n   * @param {number} [index] index from start\n   * @param {boolean} [skipCaching]\n   */\n  _getCursorBoundaries(\n    index: number = this.selectionStart,\n    skipCaching?: boolean,\n  ): CursorBoundaries {\n    const left = this._getLeftOffset(),\n      top = this._getTopOffset(),\n      offsets = this._getCursorBoundariesOffsets(index, skipCaching);\n    return {\n      left: left,\n      top: top,\n      leftOffset: offsets.left,\n      topOffset: offsets.top,\n    };\n  }\n\n  /**\n   * Caches and returns cursor left/top offset relative to instance's center point\n   * @private\n   * @param {number} index index from start\n   * @param {boolean} [skipCaching]\n   */\n  _getCursorBoundariesOffsets(\n    index: number,\n    skipCaching?: boolean,\n  ): { left: number; top: number } {\n    if (skipCaching) {\n      return this.__getCursorBoundariesOffsets(index);\n    }\n    if (this.cursorOffsetCache && 'top' in this.cursorOffsetCache) {\n      return this.cursorOffsetCache as { left: number; top: number };\n    }\n    return (this.cursorOffsetCache = this.__getCursorBoundariesOffsets(index));\n  }\n\n  /**\n   * Calculates cursor left/top offset relative to instance's center point\n   * @private\n   * @param {number} index index from start\n   */\n  __getCursorBoundariesOffsets(index: number) {\n    let topOffset = 0,\n      leftOffset = 0;\n    const { charIndex, lineIndex } = this.get2DCursorLocation(index);\n\n    for (let i = 0; i < lineIndex; i++) {\n      topOffset += this.getHeightOfLine(i);\n    }\n    const lineLeftOffset = this._getLineLeftOffset(lineIndex);\n    const bound = this.__charBounds[lineIndex][charIndex];\n    bound && (leftOffset = bound.left);\n    if (\n      this.charSpacing !== 0 &&\n      charIndex === this._textLines[lineIndex].length\n    ) {\n      leftOffset -= this._getWidthOfCharSpacing();\n    }\n    const boundaries = {\n      top: topOffset,\n      left: lineLeftOffset + (leftOffset > 0 ? leftOffset : 0),\n    };\n    if (this.direction === 'rtl') {\n      if (\n        this.textAlign === RIGHT ||\n        this.textAlign === JUSTIFY ||\n        this.textAlign === JUSTIFY_RIGHT\n      ) {\n        boundaries.left *= -1;\n      } else if (this.textAlign === LEFT || this.textAlign === JUSTIFY_LEFT) {\n        boundaries.left = lineLeftOffset - (leftOffset > 0 ? leftOffset : 0);\n      } else if (\n        this.textAlign === CENTER ||\n        this.textAlign === JUSTIFY_CENTER\n      ) {\n        boundaries.left = lineLeftOffset - (leftOffset > 0 ? leftOffset : 0);\n      }\n    }\n    return boundaries;\n  }\n\n  /**\n   * Renders cursor on context Top, outside the animation cycle, on request\n   * Used for the drag/drop effect.\n   * If contextTop is not available, do nothing.\n   */\n  renderCursorAt(selectionStart: number) {\n    this._renderCursor(\n      this.canvas!.contextTop,\n      this._getCursorBoundaries(selectionStart, true),\n      selectionStart,\n    );\n  }\n\n  /**\n   * Renders cursor\n   * @param {Object} boundaries\n   * @param {CanvasRenderingContext2D} ctx transformed context to draw on\n   */\n  renderCursor(ctx: CanvasRenderingContext2D, boundaries: CursorBoundaries) {\n    this._renderCursor(ctx, boundaries, this.selectionStart);\n  }\n\n  /**\n   * Return the data needed to render the cursor for given selection start\n   * The left,top are relative to the object, while width and height are prescaled\n   * to look think with canvas zoom and object scaling,\n   * so they depend on canvas and object scaling\n   */\n  getCursorRenderingData(\n    selectionStart: number = this.selectionStart,\n    boundaries: CursorBoundaries = this._getCursorBoundaries(selectionStart),\n  ): CursorRenderingData {\n    const cursorLocation = this.get2DCursorLocation(selectionStart),\n      lineIndex = cursorLocation.lineIndex,\n      charIndex =\n        cursorLocation.charIndex > 0 ? cursorLocation.charIndex - 1 : 0,\n      charHeight = this.getValueOfPropertyAt(lineIndex, charIndex, 'fontSize'),\n      multiplier = this.getObjectScaling().x * this.canvas!.getZoom(),\n      cursorWidth = this.cursorWidth / multiplier,\n      dy = this.getValueOfPropertyAt(lineIndex, charIndex, 'deltaY'),\n      topOffset =\n        boundaries.topOffset +\n        ((1 - this._fontSizeFraction) * this.getHeightOfLine(lineIndex)) /\n          this.lineHeight -\n        charHeight * (1 - this._fontSizeFraction);\n\n    return {\n      color:\n        this.cursorColor ||\n        (this.getValueOfPropertyAt(lineIndex, charIndex, 'fill') as string),\n      opacity: this._currentCursorOpacity,\n      left: boundaries.left + boundaries.leftOffset - cursorWidth / 2,\n      top: topOffset + boundaries.top + dy,\n      width: cursorWidth,\n      height: charHeight,\n    };\n  }\n\n  /**\n   * Render the cursor at the given selectionStart.\n   *\n   */\n  _renderCursor(\n    ctx: CanvasRenderingContext2D,\n    boundaries: CursorBoundaries,\n    selectionStart: number,\n  ) {\n    const { color, opacity, left, top, width, height } =\n      this.getCursorRenderingData(selectionStart, boundaries);\n    ctx.fillStyle = color;\n    ctx.globalAlpha = opacity;\n    ctx.fillRect(left, top, width, height);\n  }\n\n  /**\n   * Renders text selection\n   * @param {Object} boundaries Object with left/top/leftOffset/topOffset\n   * @param {CanvasRenderingContext2D} ctx transformed context to draw on\n   */\n  renderSelection(ctx: CanvasRenderingContext2D, boundaries: CursorBoundaries) {\n    const selection = {\n      selectionStart: this.inCompositionMode\n        ? this.hiddenTextarea!.selectionStart\n        : this.selectionStart,\n      selectionEnd: this.inCompositionMode\n        ? this.hiddenTextarea!.selectionEnd\n        : this.selectionEnd,\n    };\n    this._renderSelection(ctx, selection, boundaries);\n  }\n\n  /**\n   * Renders drag start text selection\n   */\n  renderDragSourceEffect() {\n    const dragStartSelection =\n      this.draggableTextDelegate.getDragStartSelection()!;\n    this._renderSelection(\n      this.canvas!.contextTop,\n      dragStartSelection,\n      this._getCursorBoundaries(dragStartSelection.selectionStart, true),\n    );\n  }\n\n  renderDropTargetEffect(e: DragEvent) {\n    const dragSelection = this.getSelectionStartFromPointer(e);\n    this.renderCursorAt(dragSelection);\n  }\n\n  /**\n   * Renders text selection\n   * @private\n   * @param {{ selectionStart: number, selectionEnd: number }} selection\n   * @param {Object} boundaries Object with left/top/leftOffset/topOffset\n   * @param {CanvasRenderingContext2D} ctx transformed context to draw on\n   */\n  _renderSelection(\n    ctx: CanvasRenderingContext2D,\n    selection: { selectionStart: number; selectionEnd: number },\n    boundaries: CursorBoundaries,\n  ) {\n    const selectionStart = selection.selectionStart,\n      selectionEnd = selection.selectionEnd,\n      isJustify = this.textAlign.includes(JUSTIFY),\n      start = this.get2DCursorLocation(selectionStart),\n      end = this.get2DCursorLocation(selectionEnd),\n      startLine = start.lineIndex,\n      endLine = end.lineIndex,\n      startChar = start.charIndex < 0 ? 0 : start.charIndex,\n      endChar = end.charIndex < 0 ? 0 : end.charIndex;\n\n    for (let i = startLine; i <= endLine; i++) {\n      const lineOffset = this._getLineLeftOffset(i) || 0;\n      let lineHeight = this.getHeightOfLine(i),\n        realLineHeight = 0,\n        boxStart = 0,\n        boxEnd = 0;\n\n      if (i === startLine) {\n        boxStart = this.__charBounds[startLine][startChar].left;\n      }\n      if (i >= startLine && i < endLine) {\n        boxEnd =\n          isJustify && !this.isEndOfWrapping(i)\n            ? this.width\n            : this.getLineWidth(i) || 5; // WTF is this 5?\n      } else if (i === endLine) {\n        if (endChar === 0) {\n          boxEnd = this.__charBounds[endLine][endChar].left;\n        } else {\n          const charSpacing = this._getWidthOfCharSpacing();\n          boxEnd =\n            this.__charBounds[endLine][endChar - 1].left +\n            this.__charBounds[endLine][endChar - 1].width -\n            charSpacing;\n        }\n      }\n      realLineHeight = lineHeight;\n      if (this.lineHeight < 1 || (i === endLine && this.lineHeight > 1)) {\n        lineHeight /= this.lineHeight;\n      }\n      let drawStart = boundaries.left + lineOffset + boxStart,\n        drawHeight = lineHeight,\n        extraTop = 0;\n      const drawWidth = boxEnd - boxStart;\n      if (this.inCompositionMode) {\n        ctx.fillStyle = this.compositionColor || 'black';\n        drawHeight = 1;\n        extraTop = lineHeight;\n      } else {\n        ctx.fillStyle = this.selectionColor;\n      }\n      if (this.direction === 'rtl') {\n        if (\n          this.textAlign === RIGHT ||\n          this.textAlign === JUSTIFY ||\n          this.textAlign === JUSTIFY_RIGHT\n        ) {\n          drawStart = this.width - drawStart - drawWidth;\n        } else if (this.textAlign === LEFT || this.textAlign === JUSTIFY_LEFT) {\n          drawStart = boundaries.left + lineOffset - boxEnd;\n        } else if (\n          this.textAlign === CENTER ||\n          this.textAlign === JUSTIFY_CENTER\n        ) {\n          drawStart = boundaries.left + lineOffset - boxEnd;\n        }\n      }\n      ctx.fillRect(\n        drawStart,\n        boundaries.top + boundaries.topOffset + extraTop,\n        drawWidth,\n        drawHeight,\n      );\n      boundaries.topOffset += realLineHeight;\n    }\n  }\n\n  /**\n   * High level function to know the height of the cursor.\n   * the currentChar is the one that precedes the cursor\n   * Returns fontSize of char at the current cursor\n   * Unused from the library, is for the end user\n   * @return {Number} Character font size\n   */\n  getCurrentCharFontSize(): number {\n    const cp = this._getCurrentCharIndex();\n    return this.getValueOfPropertyAt(cp.l, cp.c, 'fontSize');\n  }\n\n  /**\n   * High level function to know the color of the cursor.\n   * the currentChar is the one that precedes the cursor\n   * Returns color (fill) of char at the current cursor\n   * if the text object has a pattern or gradient for filler, it will return that.\n   * Unused by the library, is for the end user\n   * @return {String | TFiller} Character color (fill)\n   */\n  getCurrentCharColor(): string | TFiller | null {\n    const cp = this._getCurrentCharIndex();\n    return this.getValueOfPropertyAt(cp.l, cp.c, FILL);\n  }\n\n  /**\n   * Returns the cursor position for the getCurrent.. functions\n   * @private\n   */\n  _getCurrentCharIndex() {\n    const cursorPosition = this.get2DCursorLocation(this.selectionStart, true),\n      charIndex =\n        cursorPosition.charIndex > 0 ? cursorPosition.charIndex - 1 : 0;\n    return { l: cursorPosition.lineIndex, c: charIndex };\n  }\n\n  dispose() {\n    this.exitEditingImpl();\n    this.draggableTextDelegate.dispose();\n    super.dispose();\n  }\n}\n\nclassRegistry.setClass(IText);\n// legacy\nclassRegistry.setClass(IText, 'i-text');\n"],"names":["protectedDefaultValues","_selectionDirection","_reSpace","inCompositionMode","iTextDefaultValues","_objectSpread","selectionStart","selectionEnd","selectionColor","isEditing","editable","column","dataType","editingBorderColor","cursorWidth","cursorColor","cursorDelay","cursorDuration","caching","hiddenTextareaContainer","keysMap","keysMapRtl","ctrlKeysMapDown","ctrlKeysMapUp","IText","ITextClickBehavior","getDefaults","ownDefaults","type","constructor","text","options","initBehavior","_set","key","value","_savedProps","canvas","Canvas","textEditingManager","remove","add","setSelectionStart","index","Math","max","_updateAndFire","setSelectionEnd","min","length","property","_fireSelectionChanged","_updateTextarea","getCharOffset","position","topOffset","leftOffset","cursorPosition","get2DCursorLocation","charIndex","lineIndex","i","getHeightOfLine","lineLeftOffset","_getLineLeftOffset","bound","__charBounds","left","charSpacing","_textLines","_getWidthOfCharSpacing","x","y","_renderBackground","ctx","backgroundColor","dim","_getNonTransformedDimensions","scaleX","scaleY","fillStyle","group","fillRect","padding","_removeShadow","fire","target","initDimensions","initDelayedCursor","getSelectionStyles","startIndex","arguments","undefined","endIndex","complete","setSelectionStyles","styles","skipWrapping","render","cursorOffsetCache","renderCursorOrSelection","toCanvasElement","clearContextTop","boundaries","_getCursorBoundaries","renderCursor","renderSelection","contextTopDirty","restore","skipCaching","_getLeftOffset","top","_getTopOffset","offsets","_getCursorBoundariesOffsets","__getCursorBoundariesOffsets","direction","textAlign","RIGHT","JUSTIFY","JUSTIFY_RIGHT","LEFT","JUSTIFY_LEFT","CENTER","JUSTIFY_CENTER","renderCursorAt","_renderCursor","contextTop","getCursorRenderingData","cursorLocation","charHeight","getValueOfPropertyAt","multiplier","getObjectScaling","getZoom","dy","_fontSizeFraction","lineHeight","color","opacity","_currentCursorOpacity","width","height","globalAlpha","selection","hiddenTextarea","_renderSelection","renderDragSourceEffect","dragStartSelection","draggableTextDelegate","getDragStartSelection","renderDropTargetEffect","e","dragSelection","getSelectionStartFromPointer","isJustify","includes","start","end","startLine","endLine","startChar","endChar","lineOffset","realLineHeight","boxStart","boxEnd","isEndOfWrapping","getLineWidth","drawStart","drawHeight","extraTop","drawWidth","compositionColor","getCurrentCharFontSize","cp","_getCurrentCharIndex","l","c","getCurrentCharColor","FILL","dispose","exitEditingImpl","_defineProperty","classRegistry","setClass"],"mappings":"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"}