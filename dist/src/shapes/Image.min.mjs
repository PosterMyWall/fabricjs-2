import{defineProperty as t,objectSpread2 as e,objectWithoutProperties as i}from"../../_virtual/_rollupPluginBabelHelpers.min.mjs";import{getFabricDocument as s,getEnv as h}from"../env/index.min.mjs";import{getFilterBackend as r}from"../filters/FilterBackend.min.mjs";import{SHARED_ATTRIBUTES as l}from"../parser/attributes.min.mjs";import{parseAttributes as n}from"../parser/parseAttributes.min.mjs";import{uid as a}from"../util/internals/uid.min.mjs";import{createCanvasElementFor as o}from"../util/misc/dom.min.mjs";import{findScaleToFit as c,findScaleToCover as m}from"../util/misc/findScaleTo.min.mjs";import{loadImage as g,enlivenObjects as _,enlivenObjectEnlivables as d}from"../util/misc/objectEnlive.min.mjs";import{parsePreserveAspectRatioAttribute as p}from"../util/misc/svgParsing.min.mjs";import{classRegistry as f}from"../ClassRegistry.min.mjs";import{FabricObject as u}from"./Object/FabricObject.min.mjs";import{WebGLFilterBackend as S}from"../filters/WebGLFilterBackend.min.mjs";import{FILL as w,NONE as E}from"../constants.min.mjs";import{getDocumentFromElement as v}from"../util/dom_misc.min.mjs";import{log as y}from"../util/internals/console.min.mjs";import{cacheProperties as O}from"./Object/defaultValues.min.mjs";const j=["filters","resizeFilter","src","crossOrigin","type"],x={strokeWidth:0,srcFromAttribute:!1,minimumScaleTrigger:.5,cropX:0,cropY:0,imageSmoothing:!0,ignoreApplyFilters:!1},F=["cropX","cropY"];class b extends u{static getDefaults(){return e(e({},super.getDefaults()),b.ownDefaults)}constructor(e,i){super(),t(this,"_lastScaleX",1),t(this,"_lastScaleY",1),t(this,"_filterScalingX",1),t(this,"_filterScalingY",1),this.filters=[],Object.assign(this,b.ownDefaults),this.setOptions(i),this.cacheKey="texture".concat(a()),this.setElement("string"==typeof e?(this.canvas&&v(this.canvas.getElement())||s()).getElementById(e):e,i)}getElement(){return this._element}setElement(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._element=t,this._originalElement=t,this._setWidthHeight(e),t.classList.add(b.CSS_CANVAS),0!==this.filters.length&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters()}removeTexture(t){const e=r(!1);e instanceof S&&e.evictCachesForKey(t)}dispose(){super.dispose(),this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._cacheContext=null,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((t=>{const e=this[t];e&&h().dispose(e),this[t]=void 0}))}getCrossOrigin(){return this._originalElement&&(this._originalElement.crossOrigin||null)}getOriginalSize(){const t=this.getElement();return t?{width:t.naturalWidth||t.width,height:t.naturalHeight||t.height}:{width:0,height:0}}_stroke(t){if(!this.stroke||0===this.strokeWidth)return;const e=this.width/2,i=this.height/2;t.beginPath(),t.moveTo(-e,-i),t.lineTo(e,-i),t.lineTo(e,i),t.lineTo(-e,i),t.lineTo(-e,-i),t.closePath()}toObject(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const i=[];return this.filters.forEach((t=>{t&&i.push(t.toObject())})),e(e({},super.toObject([...F,...t])),{},{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:i},this.resizeFilter?{resizeFilter:this.resizeFilter.toObject()}:{})}hasCrop(){return!!this.cropX||!!this.cropY||this.width<this._element.width||this.height<this._element.height}_toSVG(){const t=[],e=this._element,i=-this.width/2,s=-this.height/2;let h=[],r=[],l="",n="";if(!e)return[];if(this.hasCrop()){const t=a();h.push('<clipPath id="imageCrop_'+t+'">\n','\t<rect x="'+i+'" y="'+s+'" width="'+this.width+'" height="'+this.height+'" />\n',"</clipPath>\n"),l=' clip-path="url(#imageCrop_'+t+')" '}if(this.imageSmoothing||(n=' image-rendering="optimizeSpeed"'),t.push("\t<image ","COMMON_PARTS",'xlink:href="'.concat(this.getSvgSrc(!0),'" x="').concat(i-this.cropX,'" y="').concat(s-this.cropY,'" width="').concat(e.width||e.naturalWidth,'" height="').concat(e.height||e.naturalHeight,'"').concat(n).concat(l,"></image>\n")),this.stroke||this.strokeDashArray){const t=this.fill;this.fill=null,r=['\t<rect x="'.concat(i,'" y="').concat(s,'" width="').concat(this.width,'" height="').concat(this.height,'" style="').concat(this.getSvgStyles(),'" />\n')],this.fill=t}return h=this.paintFirst!==w?h.concat(r,t):h.concat(t,r),h}getSrc(t){const e=t?this._element:this._originalElement;return e?e.toDataURL?e.toDataURL():this.srcFromAttribute?e.getAttribute("src")||"":e.src:this.src||""}getSvgSrc(t){return this.getSrc(t)}setSrc(t){let{crossOrigin:e,signal:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return g(t,{crossOrigin:e,signal:i}).then((t=>{void 0!==e&&this.set({crossOrigin:e}),this.setElement(t)}))}toString(){return'#<Image: { src: "'.concat(this.getSrc(),'" }>')}applyResizeFilters(){const t=this.resizeFilter,e=this.minimumScaleTrigger,i=this.getTotalObjectScaling(),s=i.x,h=i.y,l=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!t||s>e&&h>e)return this._element=l,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=s,void(this._lastScaleY=h);const n=o(l),{width:a,height:c}=l;this._element=n,this._lastScaleX=t.scaleX=s,this._lastScaleY=t.scaleY=h,r().applyFilters([t],l,a,c,this._element),this._filterScalingX=n.width/this._originalElement.width,this._filterScalingY=n.height/this._originalElement.height}applyFilters(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.filters||[];if(t=t.filter((t=>t&&!t.isNeutralState())),this.set("dirty",!0),this.removeTexture("".concat(this.cacheKey,"_filtered")),0===t.length)return this._element=this._originalElement,this._filteredEl=void 0,this._filterScalingX=1,void(this._filterScalingY=1);const e=this._originalElement,i=e.naturalWidth||e.width,s=e.naturalHeight||e.height;if("VIDEO"===e.nodeName||this.ignoreApplyFilters)return this;if(this._element===this._originalElement){const t=o({width:i,height:s});this._element=t,this._filteredEl=t}else this._filteredEl&&(this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,i,s),this._lastScaleX=1,this._lastScaleY=1);r().applyFilters(t,this._originalElement,i,s,this._element),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height)}_render(t){t.imageSmoothingEnabled=this.imageSmoothing,!0!==this.isMoving&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(t),this._renderPaintInOrder(t)}drawCacheOnCanvas(t){t.imageSmoothingEnabled=this.imageSmoothing,super.drawCacheOnCanvas(t)}shouldCache(){return this.needsItsOwnCache()}_renderFill(t){let e=this._element;if(!e)return;const i=this._filterScalingX,s=this._filterScalingY,h=this.width,r=this.height,l=Math.max(this.cropX,0),n=Math.max(this.cropY,0),a=e.naturalWidth||e.width,o=e.naturalHeight||e.height,c=l*i,m=n*s,g=Math.min(h*i,a-c),_=Math.min(r*s,o-m),d=-h/2,p=-r/2,f=Math.min(h,a/i-l),u=Math.min(r,o/s-n);"VIDEO"===this._element.nodeName&&(e=this._applyVideoFilter(this._element));const S=performance.now();e&&t.drawImage(e,c,m,g,_,d,p,f,u);const w=performance.now();console.log("Draw image ctx",w-S)}_applyVideoFilter(t){let e=this.filters||[];if(e=e.filter((function(t){return t})),0===e.length)return this._element=this._originalElement,this._filteredEl=void 0,this._filterScalingX=1,this._filterScalingY=1,this._element;const i=t,s=i.width,h=i.height;if(this._element===i){const t=o({width:s,height:h});this._element=t,this._filteredEl=t}else{var l;null===(l=this._element.getContext("2d"))||void 0===l||l.clearRect(0,0,s,h)}r().applyFilters(e,this._originalElement,s,h,this._element),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height);const n=this._element;return this._element=i,n}_needsResize(){const t=this.getTotalObjectScaling();return t.x!==this._lastScaleX||t.y!==this._lastScaleY}_resetWidthHeight(){this.set(this.getOriginalSize())}_setWidthHeight(){let{width:t,height:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const i=this.getOriginalSize();this.width=t||i.width,this.height=e||i.height}parsePreserveAspectRatioAttribute(){const t=p(this.preserveAspectRatio||""),e=this.width,i=this.height,s={width:e,height:i};let h,r=this._element.width,l=this._element.height,n=1,a=1,o=0,g=0,_=0,d=0;return!t||t.alignX===E&&t.alignY===E?(n=e/r,a=i/l):("meet"===t.meetOrSlice&&(n=a=c(this._element,s),h=(e-r*n)/2,"Min"===t.alignX&&(o=-h),"Max"===t.alignX&&(o=h),h=(i-l*a)/2,"Min"===t.alignY&&(g=-h),"Max"===t.alignY&&(g=h)),"slice"===t.meetOrSlice&&(n=a=m(this._element,s),h=r-e/n,"Mid"===t.alignX&&(_=h/2),"Max"===t.alignX&&(_=h),h=l-i/a,"Mid"===t.alignY&&(d=h/2),"Max"===t.alignY&&(d=h),r=e/n,l=i/a)),{width:r,height:l,scaleX:n,scaleY:a,offsetLeft:o,offsetTop:g,cropX:_,cropY:d}}static fromObject(t,s){let{filters:h,resizeFilter:r,src:l,crossOrigin:n,type:a}=t,o=i(t,j);return Promise.all([g(l,e(e({},s),{},{crossOrigin:n})),h&&_(h,s),r&&_([r],s),d(o,s)]).then((t=>{let[i,s=[],[h]=[],r={}]=t;return new this(i,e(e({},o),{},{src:l,filters:s,resizeFilter:h},r))}))}static fromURL(t){let{crossOrigin:e=null,signal:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0;return g(t,{crossOrigin:e,signal:i}).then((t=>new this(t,s)))}static async fromElement(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;const s=n(t,this.ATTRIBUTE_NAMES,i);return this.fromURL(s["xlink:href"],e,s).catch((t=>(y("log","Unable to parse Image",t),null)))}}t(b,"type","Image"),t(b,"cacheProperties",[...O,...F]),t(b,"ownDefaults",x),t(b,"CSS_CANVAS","canvas-img"),t(b,"ATTRIBUTE_NAMES",[...l,"x","y","width","height","preserveAspectRatio","xlink:href","crossOrigin","image-rendering"]),f.setClass(b),f.setSVGClass(b);export{b as FabricImage,x as imageDefaultValues};
//# sourceMappingURL=Image.min.mjs.map
