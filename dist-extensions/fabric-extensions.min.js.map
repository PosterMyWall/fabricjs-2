{"version":3,"file":"fabric-extensions.min.js","sources":["../extensions/aligning_guidelines/constant.ts","../extensions/aligning_guidelines/util/draw.ts","../extensions/aligning_guidelines/util/get-objects-by-target.ts","../extensions/aligning_guidelines/util/collect-line.ts","../extensions/aligning_guidelines/util/basic.ts","../extensions/data_updaters/origins/index.ts","../extensions/aligning_guidelines/index.ts"],"sourcesContent":["import type { AligningLineConfig } from './typedefs';\n\nexport const aligningLineConfig: AligningLineConfig = {\n  /** At what distance from the shape does alignment begin? */\n  margin: 4,\n  /** Aligning line dimensions */\n  width: 1,\n  /** Aligning line color */\n  color: 'rgb(255,0,0,0.9)',\n  /** Whether to draw the x at the end of lines or not */\n  drawX: false,\n};\n","import type { Canvas } from '@postermywall/fabricjs-2';\nimport { Point } from '@postermywall/fabricjs-2';\nimport type { HorizontalLine, VerticalLine } from '../typedefs';\nimport { aligningLineConfig } from '../constant';\n\nfunction drawLine(canvas: Canvas, origin: Point, target: Point) {\n  const { width, color } = aligningLineConfig;\n  const ctx = canvas.getSelectionContext();\n  const viewportTransform = canvas.viewportTransform;\n  const zoom = canvas.getZoom();\n  ctx.save();\n  ctx.transform(...viewportTransform);\n  ctx.lineWidth = width / zoom;\n  ctx.strokeStyle = color;\n  ctx.setLineDash([5, 3]);\n  ctx.beginPath();\n  ctx.moveTo(origin.x, origin.y);\n  ctx.lineTo(target.x, target.y);\n  ctx.stroke();\n  drawX(ctx, zoom, origin);\n  drawX(ctx, zoom, target);\n  ctx.restore();\n}\n\nconst xSize = 2.4;\nfunction drawX(ctx: CanvasRenderingContext2D, zoom: number, point: Point) {\n  if(!aligningLineConfig.drawX){\n    return;\n  }\n  const size = xSize / zoom;\n  ctx.save();\n  ctx.translate(point.x, point.y);\n  ctx.beginPath();\n  ctx.moveTo(-size, -size);\n  ctx.lineTo(size, size);\n  ctx.moveTo(size, -size);\n  ctx.lineTo(-size, size);\n  ctx.stroke();\n  ctx.restore();\n}\nfunction drawPoint(canvas: Canvas, arr: Point[]) {\n  const { width, color } = aligningLineConfig;\n  const ctx = canvas.getSelectionContext();\n  const viewportTransform = canvas.viewportTransform;\n  const zoom = canvas.getZoom();\n  ctx.save();\n  ctx.transform(...viewportTransform);\n  ctx.lineWidth = width / zoom;\n  ctx.strokeStyle = color;\n  for (const item of arr) drawX(ctx, zoom, item);\n  ctx.restore();\n}\nexport function drawPointList(\n  canvas: Canvas,\n  list: Array<VerticalLine | HorizontalLine>,\n) {\n  const arr = list.map((item) => {\n    const isVertical = 'y2' in item;\n    const x = isVertical ? item.x : item.x1;\n    const y = isVertical ? item.y1 : item.y;\n    return new Point(x, y);\n  });\n  drawPoint(canvas, arr);\n}\n\nexport function drawVerticalLine(canvas: Canvas, coords: VerticalLine) {\n  const x = coords.x;\n  const origin = new Point(x, coords.y1);\n  const target = new Point(x, coords.y2);\n  drawLine(canvas, origin, target);\n}\n\nexport function drawHorizontalLine(canvas: Canvas, coords: HorizontalLine) {\n  const y = coords.y;\n  const origin = new Point(coords.x1, y);\n  const target = new Point(coords.x2, y);\n  drawLine(canvas, origin, target);\n}\n","import type { FabricObject } from '@postermywall/fabricjs-2';\nimport { ActiveSelection, Group } from '@postermywall/fabricjs-2';\n\nexport function getObjectsByTarget(target: FabricObject) {\n  const objects = new Set<FabricObject>();\n  const canvas = target.canvas;\n  if (!canvas) return objects;\n  const children =\n    target instanceof ActiveSelection ? target.getObjects() : [target];\n\n  canvas.forEachObject((o) => {\n    if (!o.isOnScreen()) return;\n    if (!o.visible) return;\n    if (o.constructor == Group) {\n      collectObjectsByGroup(objects, o);\n      return;\n    }\n    objects.add(o);\n  });\n\n  deleteObjectsByList(objects, children);\n  return objects;\n}\n\nfunction deleteObjectsByList(objects: Set<FabricObject>, list: FabricObject[]) {\n  for (const target of list) {\n    if (target.constructor == Group) {\n      deleteObjectsByList(objects, (target as Group).getObjects());\n    } else {\n      objects.delete(target);\n    }\n  }\n}\n\nfunction collectObjectsByGroup(objects: Set<FabricObject>, g: Group) {\n  const children = g.getObjects();\n  for (const child of children) {\n    if (!child.visible) continue;\n    if (child.constructor == Group) {\n      collectObjectsByGroup(objects, child);\n      continue;\n    }\n    objects.add(child);\n  }\n}\n","import type { FabricObject, TBBox } from '@postermywall/fabricjs-2';\nimport { Point } from '@postermywall/fabricjs-2';\nimport type { HorizontalLine, VerticalLine } from '../typedefs';\nimport { aligningLineConfig } from '../constant';\nimport { getDistance, setPositionDir } from './basic';\n\ntype CollectLineProps = {\n  activeObject: FabricObject;\n  activeObjectRect: TBBox;\n  objectRect: TBBox;\n};\n\nexport function collectLine(props: CollectLineProps) {\n  const aligningLineMargin = aligningLineConfig.margin;\n  const { activeObject, activeObjectRect, objectRect } = props;\n  const list = makeLineByRect(objectRect);\n  const aList = makeLineByRect(activeObjectRect);\n  const margin = aligningLineMargin / (activeObject.canvas?.getZoom() ?? 1);\n  const opts = { target: activeObject, list, aList, margin };\n  const vLines = collectVerticalLine(opts);\n  const hLines = collectHorizontalLine(opts);\n\n  return { vLines, hLines };\n}\n\ntype CollectItemLineProps = {\n  target: FabricObject;\n  list: LineProps[];\n  aList: LineProps[];\n  margin: number;\n};\nfunction collectVerticalLine(props: CollectItemLineProps) {\n  const { target, list, aList, margin } = props;\n\n  const arr = aList.map((x) => getDistanceLine(x, list, 'x'));\n  const min = Math.min(...arr.map((x) => x.dis));\n  if (min > margin) return [];\n  const lines: VerticalLine[] = [];\n  const width = aList[0].x2 - aList[0].x;\n  const height = aList[0].y2 - aList[0].y;\n  let b = false;\n  for (let i = 0; i < arr.length; i++) {\n    const item = arr[i];\n    if (min == item.dis) {\n      const line = list[item.index];\n      const aLine = aList[item.index];\n      const x = line.x;\n      const y = aLine.y;\n\n      const y1 = Math.min(line.y, line.y2, y, aLine.y2);\n      const y2 = Math.max(line.y, line.y2, y, aLine.y2);\n      // 参考线可画多条\n      lines.push({ x, y1, y2 });\n      if (b) continue;\n      b = true;\n      // 对齐只进行一次\n      setPos({\n        target,\n        x,\n        y,\n        centerX: i - 1,\n        centerY: item.index - 1,\n        width,\n        height,\n        dir: 'x',\n      });\n      const dis = min * item.dir;\n      aList.forEach((x) => (x.x -= dis));\n    }\n  }\n  return lines;\n}\n\nfunction collectHorizontalLine(props: CollectItemLineProps) {\n  const { target, list, aList, margin } = props;\n\n  const arr = aList.map((x) => getDistanceLine(x, list, 'y'));\n  const min = Math.min(...arr.map((x) => x.dis));\n  if (min > margin) return [];\n  const lines: HorizontalLine[] = [];\n  const width = aList[0].x2 - aList[0].x;\n  const height = aList[0].y2 - aList[0].y;\n  let b = false;\n  for (let i = 0; i < arr.length; i++) {\n    const item = arr[i];\n    if (min == item.dis) {\n      const line = list[item.index];\n      const aLine = aList[item.index];\n      const y = line.y;\n      const x = aLine.x;\n\n      const x1 = Math.min(line.x, line.x2, x, aLine.x2);\n      const x2 = Math.max(line.x, line.x2, x, aLine.x2);\n      // 参考线可画多条\n      lines.push({ y, x1, x2 });\n      if (b) continue;\n      b = true;\n      // 对齐只进行一次\n      setPos({\n        target,\n        x,\n        y,\n        centerX: item.index - 1,\n        centerY: i - 1,\n        width,\n        height,\n        dir: 'y',\n      });\n      const dis = min * item.dir;\n      aList.forEach((x) => (x.y -= dis));\n    }\n  }\n  return lines;\n}\n\ntype LineProps = {\n  x: number;\n  y: number;\n  x2: number;\n  y2: number;\n};\nfunction getDistanceLine(\n  target: LineProps,\n  list: LineProps[],\n  type: 'x' | 'y',\n) {\n  let dis = Infinity;\n  let index = -1;\n  /** 1正值 -1负值 */\n  let dir = 1;\n  for (let i = 0; i < list.length; i++) {\n    const v = getDistance(target[type], list[i][type]);\n    if (dis > v) {\n      index = i;\n      dis = v;\n      dir = target[type] > list[i][type] ? 1 : -1;\n    }\n  }\n  return { dis, index, dir };\n}\n\nfunction makeLineByRect(rect: TBBox) {\n  const { left, top, width, height } = rect;\n  const a = { x: left, y: top, x2: left + width, y2: top + height };\n  const x = left + width / 2;\n  const y = top + height / 2;\n  const b = { x, y, x2: x, y2: y };\n  const c = { x: left + width, x2: left, y: top + height, y2: top };\n\n  return [a, b, c];\n}\n\ntype SnapToPixelProps = {\n  target: FabricObject;\n  x: number;\n  y: number;\n  /** -1 0 1 */\n  centerX: number;\n  /** -1 0 1 */\n  centerY: number;\n  width: number;\n  height: number;\n  dir: 'x' | 'y';\n};\nfunction setPos(props: SnapToPixelProps) {\n  const { target, centerX, centerY, width, height, dir } = props;\n  let { x, y } = props;\n  x -= (centerX * width) / 2;\n  y -= (centerY * height) / 2;\n  setPositionDir(target, new Point(x, y), dir);\n  target.setCoords();\n}\n","import type { FabricObject, Point } from '@postermywall/fabricjs-2';\n\nexport function getDistance(a: number, b: number) {\n  return Math.abs(a - b);\n}\n\nexport function setPositionDir(\n  target: FabricObject,\n  pos: Point,\n  dir: 'x' | 'y',\n) {\n  const center = target.translateToCenterPoint(pos, 'center', 'center');\n  const position = target.translateToOriginPoint(\n    center,\n    target.originX,\n    target.originY,\n  );\n  if (dir == 'x') target.setX(position.x);\n  else target.setY(position.y);\n}\n","import {\n  Point,\n  FabricImage,\n  Group,\n  BaseFabricObject,\n  type FabricObject,\n  type TOriginX,\n  type TOriginY,\n} from '@postermywall/fabricjs-2';\n\n/**\n * Updates the fromObject function of a class to return a version that can restore old data\n * with values of originX and originY that are different from 'center', 'center'\n * Used to upgrade from fabric 6 to fabric 7\n * @param originalFn the original fromObject function of an object,\n * @param defaultOriginX optional default value for non exported originX,\n * @param defaultOriginY optional default value for non exported originY,\n * @returns a wrapped fromObject function for the object\n */\nexport const originUpdaterWrapper = <T extends FabricObject = FabricObject>(\n  originalFn: (...args: any[]) => Promise<T>,\n  defaultOriginX: TOriginX = 'left',\n  defaultOriginY: TOriginY = 'top',\n): ((...args: any[]) => Promise<T>) =>\n  async function (this: T, serializedObject, ...args) {\n    // we default to left and top because those are defaults before deprecation\n    const { originX = defaultOriginX, originY = defaultOriginY } =\n      serializedObject;\n    // and we do not want to pass those properties on the object anymore\n    delete serializedObject.originX;\n    delete serializedObject.originY;\n    const originalObject = await originalFn.call(\n      this,\n      serializedObject,\n      ...args,\n    );\n    const actualPosition = new Point(originalObject.left, originalObject.top);\n    originalObject.setPositionByOrigin(actualPosition, originX, originY);\n    return originalObject;\n  };\n\n/**\n * Wraps and override the current fabricJS fromObject static functions\n * Used to upgrade from fabric 6 to fabric 7\n * @param defaultOriginX optional default value for non exported originX,\n * @param defaultOriginY optional default value for non exported originY,\n * @returns a wrapped fromObject function for the object\n */\nexport const installOriginWrapperUpdater = (\n  originX?: TOriginX,\n  originY?: TOriginY,\n) => {\n  // @ts-expect-error the _fromObject parameter could be instantiated differently\n  BaseFabricObject._fromObject = originUpdaterWrapper<FabricObject>(\n    BaseFabricObject._fromObject,\n    originX,\n    originY,\n  );\n  // FabricImage and Group do not use _fromObject\n  FabricImage.fromObject = originUpdaterWrapper<FabricImage>(\n    FabricImage.fromObject,\n    originX,\n    originY,\n  );\n  Group.fromObject = originUpdaterWrapper<Group>(\n    Group.fromObject,\n    originX,\n    originY,\n  );\n};\n","import type {\n  BasicTransformEvent,\n  Canvas,\n  FabricObject,\n  TBBox,\n  TPointerEvent,\n} from '@postermywall/fabricjs-2';\nimport { Point, util } from '@postermywall/fabricjs-2';\nimport {\n  collectHorizontalPoint,\n  collectVerticalPoint,\n} from './util/collect-point';\nimport {\n  drawHorizontalLine,\n  drawPointList,\n  drawVerticalLine,\n} from './util/draw';\nimport { getObjectsByTarget } from './util/get-objects-by-target';\nimport { collectLine } from './util/collect-line';\nimport type {\n  AligningLineConfig,\n  HorizontalLine,\n  VerticalLine,\n} from './typedefs';\nimport { aligningLineConfig } from './constant';\n\ntype TransformEvent = BasicTransformEvent<TPointerEvent> & {\n  target: FabricObject;\n};\n\nexport type { AligningLineConfig } from './typedefs';\n\nexport function initAligningGuidelines(\n  canvas: Canvas,\n  options: Partial<AligningLineConfig> = {},\n) {\n  Object.assign(aligningLineConfig, options);\n\n  const horizontalLines = new Set<string>();\n  const verticalLines = new Set<string>();\n  let onlyDrawPoint = false;\n  const cacheMap = new Map<string, [TBBox, Point[]]>();\n\n  const getCaCheMapValue = (object: FabricObject) => {\n    const cacheKey = [\n      object.calcTransformMatrix().toString(),\n      object.width,\n      object.height,\n    ].join();\n    const cacheValue = cacheMap.get(cacheKey);\n    if (cacheValue) return cacheValue;\n    const coords = object.getCoords();\n    const rect = util.makeBoundingBoxFromPoints(coords);\n    const value: [TBBox, Point[]] = [rect, coords];\n    cacheMap.set(cacheKey, value);\n    return value;\n  };\n\n  function moving(e: TransformEvent) {\n    const activeObject = e.target;\n    activeObject.setCoords();\n    onlyDrawPoint = false;\n    verticalLines.clear();\n    horizontalLines.clear();\n\n    const objects = getObjectsByTarget(activeObject);\n    const activeObjectRect = activeObject.getBoundingRect();\n\n    for (const object of objects) {\n      const objectRect = getCaCheMapValue(object)[0];\n      const { vLines, hLines } = collectLine({\n        activeObject,\n        activeObjectRect,\n        objectRect,\n      });\n      vLines.forEach((o) => {\n        verticalLines.add(JSON.stringify(o));\n      });\n      hLines.forEach((o) => {\n        horizontalLines.add(JSON.stringify(o));\n      });\n    }\n  }\n\n  function scalingOrResizing(e: TransformEvent) {\n    // br bl tr tl mb ml mt mr\n    const activeObject = e.target;\n    activeObject.setCoords();\n    const isScale = String(e.transform.action).startsWith('scale');\n    verticalLines.clear();\n    horizontalLines.clear();\n\n    const objects = getObjectsByTarget(activeObject);\n    let corner = e.transform.corner;\n    if (activeObject.flipX) corner = corner.replace('l', 'r').replace('r', 'l');\n    if (activeObject.flipY) corner = corner.replace('t', 'b').replace('b', 't');\n    let index = ['tl', 'tr', 'br', 'bl', 'mt', 'mr', 'mb', 'ml'].indexOf(\n      corner,\n    );\n    if (index == -1) return;\n    onlyDrawPoint = index > 3;\n    if (onlyDrawPoint) {\n      const angle = activeObject.getTotalAngle();\n      if (angle % 90 != 0) return;\n      index -= 4;\n    }\n    let point = activeObject.getCoords()[index];\n    for (const object of objects) {\n      const [rect, coords] = getCaCheMapValue(object);\n      const center = new Point(\n        rect.left + rect.width / 2,\n        rect.top + rect.height / 2,\n      );\n      const list = [...coords, center];\n      const props = { activeObject, point, list, isScale, index };\n      const vLines = collectVerticalPoint(props);\n      const hLines = collectHorizontalPoint(props);\n      vLines.forEach((o) => {\n        verticalLines.add(JSON.stringify(o));\n      });\n      hLines.forEach((o) => {\n        horizontalLines.add(JSON.stringify(o));\n      });\n      if (vLines.length || hLines.length)\n        point = activeObject.getCoords()[index];\n    }\n  }\n\n  function beforeRender() {\n    canvas.clearContext(canvas.contextTop);\n  }\n  function afterRender() {\n    if (onlyDrawPoint) {\n      const list: Array<VerticalLine | HorizontalLine> = [];\n      for (const v of verticalLines) list.push(JSON.parse(v));\n      for (const h of horizontalLines) list.push(JSON.parse(h));\n      drawPointList(canvas, list);\n    } else {\n      for (const v of verticalLines) drawVerticalLine(canvas, JSON.parse(v));\n      for (const h of horizontalLines)\n        drawHorizontalLine(canvas, JSON.parse(h));\n    }\n  }\n  function mouseUp() {\n    verticalLines.clear();\n    horizontalLines.clear();\n    cacheMap.clear();\n    canvas.requestRenderAll();\n  }\n\n  // canvas.on('object:resizing', scalingOrResizing);\n  // canvas.on('object:scaling', scalingOrResizing);\n  canvas.on('object:moving', moving);\n  canvas.on('before:render', beforeRender);\n  canvas.on('after:render', afterRender);\n  canvas.on('mouse:up', mouseUp);\n\n  return () => {\n    // canvas.off('object:resizing', scalingOrResizing);\n    // canvas.off('object:scaling', scalingOrResizing);\n    canvas.off('object:moving', moving);\n    canvas.off('before:render', beforeRender);\n    canvas.off('after:render', afterRender);\n    canvas.off('mouse:up', mouseUp);\n  };\n}\n"],"names":["aligningLineConfig","margin","width","color","drawX","drawLine","canvas","origin","target","ctx","getSelectionContext","viewportTransform","zoom","getZoom","save","transform","lineWidth","strokeStyle","setLineDash","beginPath","moveTo","x","y","lineTo","stroke","restore","xSize","point","size","translate","drawPointList","list","arr","item","drawPoint","map","isVertical","x1","y1","Point","drawVerticalLine","coords","y2","drawHorizontalLine","x2","getObjectsByTarget","objects","Set","children","ActiveSelection","getObjects","forEachObject","o","isOnScreen","visible","constructor","Group","add","collectObjectsByGroup","deleteObjectsByList","delete","g","child","collectLine","props","_activeObject$canvas$","_activeObject$canvas","aligningLineMargin","activeObject","activeObjectRect","objectRect","opts","makeLineByRect","aList","vLines","getDistanceLine","min","Math","dis","lines","height","b","i","length","line","index","aLine","max","push","setPos","centerX","centerY","dir","forEach","collectVerticalLine","hLines","collectHorizontalLine","type","Infinity","v","a","abs","rect","left","top","pos","center","translateToCenterPoint","position","translateToOriginPoint","originX","originY","setX","setY","setPositionDir","setCoords","originUpdaterWrapper","originalFn","defaultOriginX","arguments","undefined","defaultOriginY","async","serializedObject","_len","args","Array","_key","originalObject","call","this","actualPosition","setPositionByOrigin","options","Object","assign","horizontalLines","verticalLines","onlyDrawPoint","cacheMap","Map","getCaCheMapValue","object","cacheKey","calcTransformMatrix","toString","join","cacheValue","get","getCoords","value","util","makeBoundingBoxFromPoints","set","moving","e","clear","getBoundingRect","JSON","stringify","beforeRender","clearContext","contextTop","afterRender","parse","h","mouseUp","requestRenderAll","on","off","installOriginWrapperUpdater","BaseFabricObject","_fromObject","FabricImage","fromObject"],"mappings":"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"}